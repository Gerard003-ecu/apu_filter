    def _analyze_metric_persistence(
        self, metric_name: str, current_value: Optional[float], threshold: float
    ) -> PersistenceAnalysisResult:
        """
        Analiza la persistencia de una m茅trica alimentando nuevos datos.

        Args:
            metric_name: Nombre de la m茅trica
            current_value: Valor actual (None si no hay datos)
            threshold: Umbral para an谩lisis de excursiones

        Returns:
            Resultado del an谩lisis de persistencia
        """
        # Alimentar nuevo dato si existe
        if current_value is not None:
            self.persistence.add_reading(metric_name, current_value)

        # Obtener an谩lisis
        return self.persistence.analyze_persistence(
            metric_name, threshold=threshold, noise_ratio=0.2, critical_ratio=0.5
        )

    def orient(self, telemetry: Optional[TelemetryData]) -> SystemStatus:
        """
        ORIENT - Segunda fase del ciclo OODA (Motor Topol贸gico).

        Analiza el estado del sistema usando:
        1. Invariantes topol贸gicos (n煤meros de Betti, salud topol贸gica)
        2. Homolog铆a persistente (patrones estructurales vs ruido)
        3. Detecci贸n de loops de reintentos

        Args:
            telemetry: Datos de telemetr铆a (puede ser None si fall贸 observe)

        Returns:
            Estado del sistema determinado por an谩lisis topol贸gico
        """
        # Obtener salud topol贸gica completa (sin an谩lisis de ciclos de negocio)
        topo_health = self.topology.get_topological_health(calculate_b1=False)

        # Preparar an谩lisis de persistencia (pueden ser vac铆os si no hay datos)
        voltage_analysis = self._analyze_metric_persistence(
            "flyback_voltage",
            telemetry.flyback_voltage if telemetry else None,
            self.thresholds.flyback_voltage_warning,
        )

        saturation_analysis = self._analyze_metric_persistence(
            "saturation",
            telemetry.saturation if telemetry else None,
            self.thresholds.saturation_warning,
        )

        # Determinar estado y construir diagn贸stico
        status, summary = self._evaluate_system_state(
            telemetry=telemetry,
            topo_health=topo_health,
            voltage_analysis=voltage_analysis,
            saturation_analysis=saturation_analysis,
        )

        # Almacenar diagn贸stico completo
        self._last_diagnosis = TopologicalDiagnosis(
            health=topo_health,
            voltage_persistence=voltage_analysis,
            saturation_persistence=saturation_analysis,
            summary=summary,
            recommended_status=status,
        )

        # Log estructurado del diagn贸stico
        if status != SystemStatus.NOMINAL:
            logger.info(f"[ORIENT] Diagn贸stico: {self._last_diagnosis.to_log_dict()}")

        return status

    def _evaluate_system_state(
        self,
        telemetry: Optional[TelemetryData],
        topo_health: TopologicalHealth,
        voltage_analysis: PersistenceAnalysisResult,
        saturation_analysis: PersistenceAnalysisResult,
    ) -> Tuple[SystemStatus, str]:
        """
        Eval煤a el estado del sistema integrando todas las fuentes de an谩lisis.

        Jerarqu铆a de evaluaci贸n (prioridad descendente):
        1. Fragmentaci贸n topol贸gica (b0 > 1)
        2. Umbrales cr铆ticos instant谩neos (safety net)
        3. Salud topol贸gica cr铆tica (health_score < 0.4)
        4. Patrones de persistencia (CRITICAL/FEATURE)
        5. Loops de reintentos
        6. Salud topol贸gica degradada (UNHEALTHY)
        7. Estado nominal

        Args:
            telemetry: Datos de telemetr铆a actuales
            topo_health: Salud topol贸gica del sistema
            voltage_analysis: An谩lisis de persistencia de voltaje
            saturation_analysis: An谩lisis de persistencia de saturaci贸n

        Returns:
            Tupla (SystemStatus, resumen_diagn贸stico)
        """
        betti = topo_health.betti

        # =====================================================================
        # 1. FRAGMENTACIN TOPOLGICA (M谩xima prioridad)
        # =====================================================================
        if not betti.is_connected:
            disconnected = ", ".join(topo_health.disconnected_nodes) or "desconocidos"
            summary = (
                f"Fragmentaci贸n Topol贸gica: 尾={betti.b0} componentes. "
                f"Nodos desconectados: [{disconnected}]"
            )
            logger.warning(f"[TOPO] 锔 {summary}")
            return SystemStatus.DISCONNECTED, summary

        # =====================================================================
        # 2. VERIFICAR DATOS DE TELEMETRA
        # =====================================================================
        if telemetry is None:
            # Sin datos pero conectado = estado desconocido
            if self._metrics.consecutive_failures > 0:
                summary = f"Sin telemetr铆a ({self._metrics.consecutive_failures} fallos)"
            else:
                summary = "Esperando datos de telemetr铆a"
            return SystemStatus.UNKNOWN, summary

        # =====================================================================
        # 3. UMBRALES CRTICOS INSTANTNEOS (Safety Net)
        # =====================================================================
        if telemetry.flyback_voltage > self.thresholds.flyback_voltage_critical:
            summary = (
                f"Voltaje Cr铆tico Instant谩neo: "
                f"{telemetry.flyback_voltage:.3f} > "
                f"{self.thresholds.flyback_voltage_critical}"
            )
            logger.critical(f"[SAFETY]  {summary}")
            return SystemStatus.CRITICO, summary

        if telemetry.saturation > self.thresholds.saturation_critical:
            summary = (
                f"Saturaci贸n Cr铆tica Instant谩nea: "
                f"{telemetry.saturation:.3f} > "
                f"{self.thresholds.saturation_critical}"
            )
            logger.critical(f"[SAFETY]  {summary}")
            return SystemStatus.CRITICO, summary

        # =====================================================================
        # 4. SALUD TOPOLGICA GENERAL
        # =====================================================================
        if topo_health.level == HealthLevel.CRITICAL:
            summary = (
                f"Salud Topol贸gica Cr铆tica: score={topo_health.health_score:.2f}. "
                f"Diagn贸sticos: {topo_health.diagnostics}"
            )
            logger.warning(f"[TOPO]  {summary}")
            return SystemStatus.CRITICO, summary

        # =====================================================================
        # 5. ANLISIS DE PERSISTENCIA
        # =====================================================================

        # Saturaci贸n persistente (m谩s grave que inestabilidad)
        if saturation_analysis.state == MetricState.CRITICAL:
            duration = saturation_analysis.metadata.get("active_duration", "?")
            summary = (
                f"Saturaci贸n Persistente Cr铆tica: excursi贸n activa por {duration} muestras"
            )
            logger.warning(f"[PERSIST]  {summary}")
            return SystemStatus.SATURADO, summary

        if saturation_analysis.state == MetricState.FEATURE:
            summary = (
                f"Saturaci贸n con Patr贸n Estructural: "
                f"{saturation_analysis.feature_count} caracter铆stica(s), "
                f"persistencia total={saturation_analysis.total_persistence:.1f}"
            )
            logger.warning(f"[PERSIST]  {summary}")
            return SystemStatus.SATURADO, summary

        # Inestabilidad de voltaje
        if voltage_analysis.state == MetricState.CRITICAL:
            duration = voltage_analysis.metadata.get("active_duration", "?")
            summary = (
                f"Inestabilidad de Voltaje Cr铆tica: excursi贸n activa por {duration} muestras"
            )
            logger.warning(f"[PERSIST]  {summary}")
            return SystemStatus.INESTABLE, summary

        if voltage_analysis.state == MetricState.FEATURE:
            summary = (
                f"Inestabilidad de Voltaje Estructural: "
                f"{voltage_analysis.feature_count} caracter铆stica(s), "
                f"max_lifespan={voltage_analysis.max_lifespan:.1f}"
            )
            logger.warning(f"[PERSIST]  {summary}")
            return SystemStatus.INESTABLE, summary

        # =====================================================================
        # 6. DETECCIN DE LOOPS DE REINTENTOS
        # =====================================================================
        if topo_health.request_loops:
            worst_loop = topo_health.request_loops[0]  # Ya ordenados por frecuencia
            if worst_loop.count >= 5:
                summary = (
                    f"Patr贸n de Reintentos Detectado: "
                    f"'{worst_loop.request_id}' apareci贸 {worst_loop.count} veces"
                )
                logger.warning(f"[TOPO]  {summary}")
                # Los loops de error indican inestabilidad
                if worst_loop.request_id.startswith("FAIL_"):
                    return SystemStatus.INESTABLE, summary

        # =====================================================================
        # 7. SALUD TOPOLGICA DEGRADADA (pero no cr铆tica)
        # =====================================================================
        if topo_health.level == HealthLevel.UNHEALTHY:
            summary = f"Salud Topol贸gica Degradada: score={topo_health.health_score:.2f}"
            logger.warning(f"[TOPO]  {summary}")
            return SystemStatus.INESTABLE, summary

        # =====================================================================
        # 8. RUIDO - Ignorar (inmunidad a falsos positivos)
        # =====================================================================
        if voltage_analysis.state == MetricState.NOISE:
            logger.debug(
                f"[PERSIST] Ruido en voltaje ignorado: "
                f"{voltage_analysis.noise_count} excursiones cortas"
            )

        if saturation_analysis.state == MetricState.NOISE:
            logger.debug(
                f"[PERSIST] Ruido en saturaci贸n ignorado: "
                f"{saturation_analysis.noise_count} excursiones cortas"
            )

        # =====================================================================
        # 9. ESTADO NOMINAL
        # =====================================================================
        summary = (
            f"Sistema Nominal: 尾={betti.b0} (conectado), "
            f"health={topo_health.health_score:.2f}"
        )
        return SystemStatus.NOMINAL, summary