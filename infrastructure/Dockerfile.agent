FROM python:3.10-slim

WORKDIR /app

# 1. Copiar requirements
COPY requirements.txt .
COPY requirements-agent.txt .

# 2. Limpiar requirements (borrar torch explícito para evitar conflictos)
RUN sed -i '/torch/d' requirements.txt

# 3. Instalar Torch CPU explícitamente
# Fijamos versiones específicas para asegurar estabilidad
RUN pip install --no-cache-dir torch==2.5.1+cpu torchvision==0.20.1+cpu torchaudio==2.5.1+cpu --index-url https://download.pytorch.org/whl/cpu

# 4. Crear archivo de constraints (EL CANDADO)
# Esto le prohíbe a pip instalar cualquier otra versión de torch
RUN echo "torch==2.5.1+cpu" > constraints.txt && \
    echo "torchvision==0.20.1+cpu" >> constraints.txt && \
    echo "torchaudio==2.5.1+cpu" >> constraints.txt

# 5. Instalar uv (Acelerador)
RUN pip install uv

# 6. Instalar el resto usando uv (RÁPIDO) + Constraints (SEGURO)
# uv respetará las versiones fijadas en constraints.txt (torch cpu)
RUN uv pip install --system --no-cache-dir \
    --requirement requirements.txt \
    --constraint constraints.txt

RUN uv pip install --system --no-cache-dir \
    --requirement requirements-agent.txt \
    --constraint constraints.txt

# 7. Crear usuario y cambiar permisos AL FINAL
RUN useradd -ms /bin/bash apu_user && \
    chown -R apu_user:apu_user /app

# 8. Cambiar a usuario no privilegiado
USER apu_user

# 9. Copiar código
COPY --chown=apu_user:apu_user agent/ /app/agent/

# 10. Configuración final
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app

# Entrypoint
ENTRYPOINT ["python", "-u", "-m", "agent.orchestrator"]
