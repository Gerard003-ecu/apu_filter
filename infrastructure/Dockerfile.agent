# =============================================================================
# DOCKERFILE.AGENT - Agente Orquestador con PyTorch CPU
# =============================================================================
# Versión: 3.0 - Resuelve conflictos de dependencias
# =============================================================================

FROM python:3.10-slim

LABEL maintainer="equipo-desarrollo" \
      version="3.0" \
      description="Agente orquestador con PyTorch CPU"

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONPATH=/app \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_ROOT_USER_ACTION=ignore

WORKDIR /app

# =============================================================================
# FASE 1: COPIAR REQUIREMENTS
# =============================================================================
COPY requirements.txt ./requirements-base.txt
COPY requirements-agent.txt ./requirements-agent.txt

# =============================================================================
# FASE 2: SCRIPT DE SEPARACIÓN DE DEPENDENCIAS
# =============================================================================
RUN cat > /tmp/separate-deps.py << 'PYTHON_SCRIPT'
import re

TORCH_RELATED = {
    'torch', 'torchvision', 'torchaudio',
    'sentence-transformers', 'transformers',
    'accelerate', 'safetensors', 'huggingface-hub',
}

def process_file(input_file, torch_output, other_output):
    torch_deps = []
    other_deps = []
    
    try:
        with open(input_file, 'r') as f:
            for line in f:
                line = line.strip()
                if not line or line.startswith('#') or line.startswith('-r'):
                    continue
                pkg_name = re.split(r'[=<>!~\[]', line)[0].lower().replace('_', '-')
                if pkg_name in TORCH_RELATED:
                    torch_deps.append(line)
                else:
                    other_deps.append(line)
    except FileNotFoundError:
        pass
    
    with open(torch_output, 'a') as f:
        for dep in torch_deps:
            f.write(dep + '\n')
    
    with open(other_output, 'a') as f:
        for dep in other_deps:
            f.write(dep + '\n')
    
    return len(torch_deps), len(other_deps)

# Inicializar archivos
open('/app/requirements-torch.txt', 'w').close()
open('/app/requirements-other.txt', 'w').close()

# Procesar ambos archivos
t1, o1 = process_file('/app/requirements-base.txt', 
                       '/app/requirements-torch.txt', 
                       '/app/requirements-other.txt')
t2, o2 = process_file('/app/requirements-agent.txt', 
                       '/app/requirements-torch.txt', 
                       '/app/requirements-other.txt')

print(f"✓ Total: {t1+t2} torch-related, {o1+o2} otras")
PYTHON_SCRIPT

RUN python /tmp/separate-deps.py

# =============================================================================
# FASE 3: INSTALAR PyTorch CPU
# =============================================================================
RUN pip install --no-cache-dir \
    torch==2.5.1+cpu \
    torchvision==0.20.1+cpu \
    torchaudio==2.5.1+cpu \
    --index-url https://download.pytorch.org/whl/cpu && \
    python -c "import torch; print(f'✓ PyTorch {torch.__version__}')"

# =============================================================================
# FASE 4: INSTALAR DEPENDENCIAS TORCH-RELATED (pip)
# =============================================================================
RUN if [ -s requirements-torch.txt ]; then \
        pip install --no-cache-dir -r requirements-torch.txt; \
    fi

# =============================================================================
# FASE 5: INSTALAR RESTO CON UV (o pip como fallback)
# =============================================================================
RUN pip install --no-cache-dir uv && \
    if [ -s requirements-other.txt ]; then \
        uv pip install --system --no-cache-dir -r requirements-other.txt || \
        pip install --no-cache-dir -r requirements-other.txt; \
    fi

# =============================================================================
# FASE 6: VERIFICACIÓN
# =============================================================================
RUN python -c "\
import torch; \
assert '+cpu' in torch.__version__, f'ERROR: torch NO es CPU: {torch.__version__}'; \
print(f'✓ torch=={torch.__version__} (CPU)')"

# =============================================================================
# FASE 7: SEGURIDAD
# =============================================================================
RUN useradd --create-home --shell /bin/bash --uid 1000 --user-group apu_user && \
    chown -R apu_user:apu_user /app && \
    rm -f requirements-*.txt

USER apu_user

# =============================================================================
# FASE 8: CÓDIGO
# =============================================================================
COPY --chown=apu_user:apu_user agent/ /app/agent/

# =============================================================================
# FASE 9: ENTRYPOINT
# =============================================================================
ENTRYPOINT ["python", "-u", "-m", "agent.orchestrator"]