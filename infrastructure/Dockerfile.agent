FROM python:3.10-slim

WORKDIR /app

# 1. Copiar requirements
COPY requirements.txt .
COPY requirements-agent.txt .

# 2. Limpiar requirements (borrar torch explícito para evitar conflictos)
RUN sed -i '/torch/d' requirements.txt

# 3. Instalar Torch CPU explícitamente
# Fijamos versiones específicas para asegurar estabilidad
RUN pip install --no-cache-dir torch==2.5.1+cpu torchvision==0.20.1+cpu torchaudio==2.5.1+cpu --index-url https://download.pytorch.org/whl/cpu

# 4. Crear archivo de constraints (EL CANDADO)
# Esto le prohíbe a pip instalar cualquier otra versión de torch
RUN echo "torch==2.5.1+cpu" > constraints.txt && \
    echo "torchvision==0.20.1+cpu" >> constraints.txt && \
    echo "torchaudio==2.5.1+cpu" >> constraints.txt

# 5. Instalar el resto usando constraints
# Agregamos --extra-index-url para que pueda verificar la metadata de torch cpu si es necesario
RUN pip install --no-cache-dir -r requirements.txt -c constraints.txt --extra-index-url https://download.pytorch.org/whl/cpu
RUN pip install --no-cache-dir -r requirements-agent.txt -c constraints.txt --extra-index-url https://download.pytorch.org/whl/cpu

# 5. Crear usuario y cambiar permisos AL FINAL
RUN useradd -ms /bin/bash apu_user && \
    chown -R apu_user:apu_user /app

# 6. Cambiar a usuario no privilegiado
USER apu_user

# 7. Copiar código
COPY --chown=apu_user:apu_user agent/ /app/agent/

# 8. Configuración final
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app

# Entrypoint
ENTRYPOINT ["python", "-u", "-m", "agent.orchestrator"]
