<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APU Filter | Centro de Análisis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { 
            --primary-color: #1e40af; 
            --secondary-color: #1d4ed8; 
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
        }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .tab-active { border-color: var(--primary-color); background-color: #eef2ff; color: var(--primary-color); }
        .tab-inactive { border-color: transparent; }
        .loader { border-top-color: var(--primary-color); animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--secondary-color); }
        .btn-primary:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .summary-card { transition: all 0.2s ease-in-out; }
        .summary-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .error-shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800">APU Filter</h1>
            <p class="text-lg text-gray-600">Centro de Análisis y Simulación para Reportes <span class="font-semibold text-gray-700">SAGUT</span></p>
        </header>

        <!-- Carga de Archivos -->
        <div id="upload-container" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2 text-gray-700">Cargar Archivos de Reporte</h2>
            <div class="grid md:grid-cols-3 gap-4">
                <div>
                    <label for="presupuesto_file" class="block text-sm font-medium text-gray-700 mb-1">
                        Presupuesto (.csv) <span class="text-red-500">*</span>
                    </label>
                    <input type="file" id="presupuesto_file" accept=".csv" 
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                           aria-required="true"/>
                    <p class="text-xs text-gray-500 mt-1" id="presupuesto-status"></p>
                </div>
                <div>
                    <label for="apus_file" class="block text-sm font-medium text-gray-700 mb-1">
                        APUs (.csv) <span class="text-red-500">*</span>
                    </label>
                    <input type="file" id="apus_file" accept=".csv" 
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                           aria-required="true"/>
                    <p class="text-xs text-gray-500 mt-1" id="apus-status"></p>
                </div>
                <div>
                    <label for="insumos_file" class="block text-sm font-medium text-gray-700 mb-1">
                        Insumos (.csv) <span class="text-red-500">*</span>
                    </label>
                    <input type="file" id="insumos_file" accept=".csv" 
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                           aria-required="true"/>
                    <p class="text-xs text-gray-500 mt-1" id="insumos-status"></p>
                </div>
            </div>
            <button onclick="AppController.procesarArchivos()" id="process-btn" 
                    class="mt-6 w-full btn-primary text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 disabled:transform-none">
                Procesar y Analizar Datos
            </button>
        </div>
        
        <!-- Contenido principal -->
        <main id="main-content" class="hidden">
            <!-- Pestañas de Navegación -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs" role="tablist">
                    <button onclick="AppController.switchTab('simulador')" id="tab-simulador" 
                            class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                            role="tab" aria-selected="true" aria-controls="content-simulador">
                        Simulador de Costos
                    </button>
                    <button onclick="AppController.switchTab('organizador')" id="tab-organizador" 
                            class="tab-inactive text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                            role="tab" aria-selected="false" aria-controls="content-organizador">
                        Organizador y Resúmenes
                    </button>
                    <button onclick="AppController.switchTab('estimador')" id="tab-estimador" 
                            class="tab-inactive text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
                            role="tab" aria-selected="false" aria-controls="content-estimador">
                        Estimador Rápido
                    </button>
                </nav>
            </div>

            <!-- Contenido de las Pestañas -->
            <div id="content-simulador" class="tab-content" role="tabpanel">
                 <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                     <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div>
                            <h2 class="text-2xl font-semibold">Simulador de Costos (AIU)</h2>
                            <p class="text-sm text-gray-500">Ajusta los porcentajes para recalcular los costos en tiempo real.</p>
                        </div>
                        <div class="text-right mt-4 md:mt-0">
                            <p class="text-gray-600">Costo Total Consolidado (+AIU)</p>
                            <p id="total-cost" class="text-3xl font-bold text-blue-800">$0</p>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-3 gap-6 items-end mt-4 pt-4 border-t">
                        <div>
                            <label for="admin_percent" class="block text-sm font-medium text-gray-700">
                                Administración (%)
                            </label>
                            <input type="number" id="admin_percent" value="9" min="0" max="100" step="0.1"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"
                                   aria-label="Porcentaje de administración">
                            <p class="text-xs text-gray-500 mt-1">Rango: 0-100%</p>
                        </div>
                        <div>
                            <label for="imprev_percent" class="block text-sm font-medium text-gray-700">
                                Imprevistos (%)
                            </label>
                            <input type="number" id="imprev_percent" value="3" min="0" max="100" step="0.1"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"
                                   aria-label="Porcentaje de imprevistos">
                            <p class="text-xs text-gray-500 mt-1">Rango: 0-100%</p>
                        </div>
                        <div>
                            <label for="util_percent" class="block text-sm font-medium text-gray-700">
                                Utilidad (%)
                            </label>
                            <input type="number" id="util_percent" value="5" min="0" max="100" step="0.1"
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2"
                                   aria-label="Porcentaje de utilidad">
                            <p class="text-xs text-gray-500 mt-1">Rango: 0-100%</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código APU</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vr. Suministro/Un. (+AIU)</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vr. Instalación/Un. (+AIU)</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vr. Construcción/Un. (+AIU)</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tiempo Instalación</th>
                                </tr>
                            </thead>
                            <tbody id="presupuesto-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-organizador" class="tab-content hidden" role="tabpanel">
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                     <h2 class="text-2xl font-semibold">Organizador de Proyecto</h2>
                     <p class="text-sm text-gray-500 mb-4">Asigna zonas y clasifica cada ítem. Los resúmenes se actualizarán automáticamente.</p>
                     <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Zona</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Material</th>
                                </tr>
                            </thead>
                            <tbody id="organizer-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-6">
                    <div id="summary-zona" class="summary-card bg-white p-6 rounded-xl shadow-md"></div>
                    <div id="summary-tipo" class="summary-card bg-white p-6 rounded-xl shadow-md"></div>
                    <div id="summary-material" class="summary-card bg-white p-6 rounded-xl shadow-md"></div>
                </div>
            </div>

            <div id="content-estimador" class="tab-content hidden" role="tabpanel">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-semibold">Estimador Rápido de Costos</h2>
                    <p class="text-sm text-gray-500 mb-6">Selecciona los parámetros para obtener una estimación de costos por m² en tiempo real.</p>

                    <div id="estimator-tool">
                        <!-- Parámetros de Entrada -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-4 border-t pt-6">
                            <div>
                                <label for="est-producto" class="block text-sm font-medium text-gray-700">Producto</label>
                                <select id="est-producto" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                    <option value="CUBIERTA">CUBIERTA</option>
                                    <option value="FACHADA">FACHADA</option>
                                </select>
                            </div>
                            <div>
                                <label for="est-material" class="block text-sm font-medium text-gray-700">Material a Instalar</label>
                                <select id="est-material" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                </select>
                            </div>
                            <div>
                                <label for="est-cuadrilla" class="block text-sm font-medium text-gray-700">Cuadrilla de</label>
                                <select id="est-cuadrilla" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5" selected>5</option>
                                    <option value="7">7</option>
                                    <option value="9">9</option>
                                </select>
                            </div>
                             <div>
                                <label for="est-m2" class="block text-sm font-medium text-gray-700">Cantidad (m²)</label>
                                <input type="number" id="est-m2" value="1" min="0.01" step="0.01"
                                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="est-zona" class="block text-sm font-medium text-gray-700">Zona</label>
                                <select id="est-zona" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                    <option value="ZONA 0">ZONA 0</option>
                                    <option value="ZONA 1">ZONA 1</option>
                                    <option value="ZONA 2">ZONA 2</option>
                                    <option value="ZONA 3">ZONA 3</option>
                                </select>
                            </div>
                            <div>
                                <label for="est-izaje" class="block text-sm font-medium text-gray-700">Izaje</label>
                                <select id="est-izaje" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                    <option value="MANUAL">MANUAL</option>
                                    <option value="GRUA">GRUA</option>
                                </select>
                            </div>
                            <div>
                                <label for="est-seguridad" class="block text-sm font-medium text-gray-700">Exigencia Seguridad</label>
                                <select id="est-seguridad" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                    <option value="NORMAL">NORMAL</option>
                                    <option value="ALTA">ALTA</option>
                                </select>
                            </div>
                        </div>

                        <!-- Resultados de la Estimación -->
                        <div class="mt-8 border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-800">Resultados de la Estimación</h3>
                            <div id="estimator-results" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600">Valor m² Suministro (+AIU)</p>
                                    <p id="est-res-suministro" class="text-xl font-bold text-gray-800">$0</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600">Valor m² Instalación (+AIU)</p>
                                    <p id="est-res-instalacion" class="text-xl font-bold text-gray-800">$0</p>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                    <p class="text-sm text-blue-700">Valor m² Construcción (+AIU)</p>
                                    <p id="est-res-construccion" class="text-2xl font-bold text-blue-800">$0</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <p class="text-sm text-gray-600">Tiempo Instalación (días/m²)</p>
                                    <p id="est-res-tiempo" class="text-xl font-bold text-gray-800">0.00</p>
                                </div>
                            </div>
                            <div id="estimator-log-container" class="mt-4 hidden">
                                <button onclick="UIManager.toggleEstimatorLog()" class="text-sm text-blue-600 hover:text-blue-800 mb-2">
                                    <span id="log-toggle-text">▶ Mostrar Log de Cálculo</span>
                                </button>
                                <textarea id="estimator-log" readonly 
                                          class="mt-1 block w-full rounded-md border-gray-200 bg-gray-50 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 hidden" 
                                          rows="10" style="font-family: monospace;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <div id="status" class="text-center p-4"></div>
        <div id="loader" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
        </div>
    </div>

    <div id="apu-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50" role="dialog" aria-modal="true">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95">
             <div class="sticky top-0 bg-white p-4 border-b flex justify-between items-center z-10">
                <h3 id="modal-title" class="text-xl font-bold">Detalle de APU</h3>
                <button onclick="ModalManager.close()" class="text-gray-500 hover:text-gray-800 text-2xl" aria-label="Cerrar modal">&times;</button>
            </div>
            <div id="modal-body" class="p-6"></div>
        </div>
    </div>
    
<script>
// ============================================================================
// CONSTANTES Y CONFIGURACIÓN
// ============================================================================
const CONFIG = {
    API_ENDPOINTS: {
        UPLOAD: '/upload',
        ESTIMATE: '/api/estimate',
        APU_DETAIL: '/api/apu/'
    },
    DEBOUNCE_DELAY: 300,
    MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
    ALLOWED_FILE_TYPES: ['.csv'],
    AIU_DEFAULTS: {
        admin: 9,
        imprev: 3,
        util: 5
    },
    AIU_LIMITS: {
        min: 0,
        max: 100
    },
    MATERIAL_MAP: {
        'CUBIERTA': ['TST', 'PANEL SANDWICH'],
        'FACHADA': ['PANEL SANDWICH', 'LOUVER', 'PERFORADA']
    },
    APU_TYPE_ORDER: {
        'Suministro': 1,
        'Suministro (Pre-fabricado)': 2,
        'Instalación': 3,
        'Obra Completa': 4,
        'Indefinido': 99
    },
    CURRENCY_OPTIONS: {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }
};

// ============================================================================
// UTILIDADES
// ============================================================================
const Utils = {
    /**
     * Debounce function para limitar llamadas
     */
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },

    /**
     * Formatea valores monetarios de forma segura
     */
    formatCurrency(value) {
        const numValue = parseFloat(value);
        if (isNaN(numValue)) return '$0';
        return numValue.toLocaleString('es-CO', CONFIG.CURRENCY_OPTIONS);
    },

    /**
     * Valida y sanitiza números
     */
    sanitizeNumber(value, defaultValue = 0, min = -Infinity, max = Infinity) {
        const num = parseFloat(value);
        if (isNaN(num)) return defaultValue;
        return Math.max(min, Math.min(max, num));
    },

    /**
     * Valida estructura de datos recibidos
     */
    validateDataStructure(data, requiredFields) {
        if (!data || typeof data !== 'object') {
            throw new Error('Datos inválidos: no es un objeto');
        }
        
        const missingFields = requiredFields.filter(field => !(field in data));
        if (missingFields.length > 0) {
            throw new Error(`Campos faltantes: ${missingFields.join(', ')}`);
        }
        
        return true;
    },

    /**
     * Validación de archivos
     */
    validateFile(file, maxSize = CONFIG.MAX_FILE_SIZE) {
        if (!file) {
            throw new Error('No se ha seleccionado ningún archivo');
        }

        const extension = '.' + file.name.split('.').pop().toLowerCase();
        if (!CONFIG.ALLOWED_FILE_TYPES.includes(extension)) {
            throw new Error(`Tipo de archivo no permitido. Use: ${CONFIG.ALLOWED_FILE_TYPES.join(', ')}`);
        }

        if (file.size > maxSize) {
            const maxSizeMB = (maxSize / (1024 * 1024)).toFixed(2);
            throw new Error(`El archivo excede el tamaño máximo de ${maxSizeMB}MB`);
        }

        return true;
    },

    /**
     * Deep clone seguro
     */
    deepClone(obj) {
        try {
            return JSON.parse(JSON.stringify(obj));
        } catch (error) {
            Logger.error('Error en deep clone:', error);
            return obj;
        }
    },

    /**
     * Escape HTML para prevenir XSS
     */
    escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }
};

// ============================================================================
// SISTEMA DE LOGGING
// ============================================================================
const Logger = {
    _logs: [],
    _maxLogs: 100,

    log(message, data = null) {
        const entry = { level: 'INFO', message, data, timestamp: new Date().toISOString() };
        console.log(`[INFO] ${message}`, data || '');
        this._addLog(entry);
    },

    warn(message, data = null) {
        const entry = { level: 'WARN', message, data, timestamp: new Date().toISOString() };
        console.warn(`[WARN] ${message}`, data || '');
        this._addLog(entry);
    },

    error(message, error = null) {
        const entry = { 
            level: 'ERROR', 
            message, 
            error: error ? { message: error.message, stack: error.stack } : null,
            timestamp: new Date().toISOString() 
        };
        console.error(`[ERROR] ${message}`, error || '');
        this._addLog(entry);
    },

    _addLog(entry) {
        this._logs.push(entry);
        if (this._logs.length > this._maxLogs) {
            this._logs.shift();
        }
    },

    getLogs(level = null) {
        return level ? this._logs.filter(log => log.level === level) : this._logs;
    },

    exportLogs() {
        return JSON.stringify(this._logs, null, 2);
    }
};

// ============================================================================
// GESTOR DE ESTADO
// ============================================================================
const StateManager = {
    _state: {
        rawData: {},
        budgetData: [],
        currentTab: 'simulador',
        aiuPercentages: { ...CONFIG.AIU_DEFAULTS },
        isProcessing: false,
        estimatorParams: {}
    },
    _listeners: [],

    /**
     * Obtener estado completo o parcial
     */
    getState(key = null) {
        return key ? this._state[key] : { ...this._state };
    },

    /**
     * Actualizar estado con validación
     */
    setState(updates) {
        const previousState = { ...this._state };
        this._state = { ...this._state, ...updates };
        
        Logger.log('Estado actualizado', { updates });
        this._notifyListeners(previousState, this._state);
    },

    /**
     * Suscribirse a cambios de estado
     */
    subscribe(listener) {
        if (typeof listener === 'function') {
            this._listeners.push(listener);
        }
    },

    /**
     * Notificar a los listeners
     */
    _notifyListeners(prevState, newState) {
        this._listeners.forEach(listener => {
            try {
                listener(newState, prevState);
            } catch (error) {
                Logger.error('Error en listener de estado:', error);
            }
        });
    },

    /**
     * Resetear estado
     */
    reset() {
        this._state = {
            rawData: {},
            budgetData: [],
            currentTab: 'simulador',
            aiuPercentages: { ...CONFIG.AIU_DEFAULTS },
            isProcessing: false,
            estimatorParams: {}
        };
        Logger.log('Estado reseteado');
    }
};

// ============================================================================
// GESTOR DE UI
// ============================================================================
const UIManager = {
    /**
     * Mostrar/ocultar loader
     */
    toggleLoader(show) {
        const loader = document.getElementById('loader');
        if (loader) {
            loader.classList.toggle('hidden', !show);
        }
    },

    /**
     * Mostrar mensajes de estado
     */
    showStatus(message, type = 'info') {
        const statusEl = document.getElementById('status');
        if (!statusEl) return;

        const classes = {
            info: 'bg-blue-100 text-blue-700 border-blue-300',
            success: 'bg-green-100 text-green-700 border-green-300',
            error: 'bg-red-100 text-red-700 border-red-300',
            warning: 'bg-yellow-100 text-yellow-700 border-yellow-300'
        };

        statusEl.textContent = message;
        statusEl.className = `text-center p-4 rounded-md mt-4 border fade-in ${classes[type] || classes.info}`;
        
        // Auto-hide después de 5 segundos para mensajes de éxito
        if (type === 'success') {
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }
    },

    /**
     * Habilitar/deshabilitar botón de procesamiento
     */
    toggleProcessButton(enabled) {
        const btn = document.getElementById('process-btn');
        if (btn) {
            btn.disabled = !enabled;
        }
    },

    /**
     * Actualizar indicadores de archivos
     */
    updateFileStatus(fileId, status, message) {
        const statusEl = document.getElementById(`${fileId}-status`);
        if (statusEl) {
            const icons = {
                success: '✓',
                error: '✗',
                info: 'ℹ'
            };
            statusEl.textContent = `${icons[status] || ''} ${message}`;
            statusEl.className = `text-xs mt-1 ${
                status === 'success' ? 'text-green-600' : 
                status === 'error' ? 'text-red-600' : 
                'text-gray-500'
            }`;
        }
    },

    /**
     * Mostrar/ocultar contenido principal
     */
    toggleMainContent(show) {
        const uploadContainer = document.getElementById('upload-container');
        const mainContent = document.getElementById('main-content');
        
        if (uploadContainer && mainContent) {
            uploadContainer.classList.toggle('hidden', show);
            mainContent.classList.toggle('hidden', !show);
        }
    },

    /**
     * Toggle del log del estimador
     */
    toggleEstimatorLog() {
        const logTextarea = document.getElementById('estimator-log');
        const toggleText = document.getElementById('log-toggle-text');
        
        if (logTextarea && toggleText) {
            const isHidden = logTextarea.classList.contains('hidden');
            logTextarea.classList.toggle('hidden');
            toggleText.textContent = isHidden ? '▼ Ocultar Log de Cálculo' : '▶ Mostrar Log de Cálculo';
        }
    },

    /**
     * Añadir animación de error
     */
    shakeElement(elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.classList.add('error-shake');
            setTimeout(() => element.classList.remove('error-shake'), 500);
        }
    }
};

// ============================================================================
// GESTOR DE MODAL
// ============================================================================
const ModalManager = {
    /**
     * Abrir modal con datos de APU
     */
    async open(apuCode) {
        const modal = document.getElementById('apu-modal');
        const modalBody = document.getElementById('modal-body');
        const modalTitle = document.getElementById('modal-title');
        
        if (!modal || !modalBody || !modalTitle) {
            Logger.error('Elementos del modal no encontrados');
            return;
        }

        modalTitle.textContent = `Detalle APU: ${Utils.escapeHtml(apuCode)}`;
        modalBody.innerHTML = '<div class="text-center py-8"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto"></div><p class="mt-4 text-gray-600">Cargando datos...</p></div>';
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        try {
            const response = await fetch(`${CONFIG.API_ENDPOINTS.APU_DETAIL}${encodeURIComponent(apuCode)}`, {
                credentials: 'include',
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error ${response.status}: ${errorText}`);
            }

            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('La respuesta del servidor no es JSON válido');
            }

            const data = await response.json();
            
            // Validar estructura de datos
            Utils.validateDataStructure(data, ['desglose']);

            modalBody.innerHTML = this._buildModalContent(data);
            Logger.log('Modal de APU abierto exitosamente', { apuCode });

        } catch (error) {
            Logger.error('Error al cargar datos del APU', error);
            modalBody.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-red-500 font-semibold">Error al cargar datos</p>
                    <p class="text-gray-600 mt-2">${Utils.escapeHtml(error.message)}</p>
                    <button onclick="ModalManager.close()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Cerrar
                    </button>
                </div>
            `;
        }
    },

    /**
     * Cerrar modal
     */
    close() {
        const modal = document.getElementById('apu-modal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            Logger.log('Modal cerrado');
        }
    },

    /**
     * Construir contenido del modal
     */
    _buildModalContent(data) {
        const aiuPcts = StateManager.getState('aiuPercentages');
        let costoDirecto = 0;
        const categories = data.desglose || {};
        let contentHTML = '<div class="space-y-6">';

        // Categorías
        const categoryOrder = ['MATERIALES', 'MANO DE OBRA', 'EQUIPO', 'OTROS'];
        
        categoryOrder.forEach(catName => {
            if (!categories[catName] || !Array.isArray(categories[catName])) return;
            
            const categoryItems = categories[catName];
            let categorySubtotal = 0;

            const isManoObra = catName === 'MANO DE OBRA';
            const tableHeaders = isManoObra ? `
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Descripción</th>
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jornal Total</th>
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rendimiento (un/día)</th>
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Valor Total</th>
            ` : `
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Descripción</th>
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Vr. Unitario</th>
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Valor Total</th>
            `;

            let tableRows = '';
            categoryItems.forEach(insumo => {
                const vrTotal = Utils.sanitizeNumber(insumo['VR_TOTAL'], 0);
                categorySubtotal += vrTotal;

                const alertaIcon = insumo.alerta ? 
                    ` <span class="text-yellow-500" title="${Utils.escapeHtml(insumo.alerta)}">⚠️</span>` : '';
                
                const descripcion = Utils.escapeHtml(insumo['DESCRIPCION'] || 'Sin descripción');

                if (isManoObra) {
                    const jornalTotal = Utils.formatCurrency(insumo['VR_UNITARIO']);
                    const rendimiento = Utils.sanitizeNumber(insumo['RENDIMIENTO'], 0).toFixed(2);
                    tableRows += `
                        <tr class="text-sm hover:bg-gray-50">
                            <td class="py-2 px-4">${descripcion}${alertaIcon}</td>
                            <td class="py-2 px-4 text-right">${jornalTotal}</td>
                            <td class="py-2 px-4 text-right">${rendimiento}</td>
                            <td class="py-2 px-4 text-right">${Utils.formatCurrency(vrTotal)}</td>
                        </tr>
                    `;
                } else {
                    const cantidad = Utils.sanitizeNumber(insumo['CANTIDAD'], 0).toFixed(3);
                    const vrUnitario = Utils.formatCurrency(insumo['VR_UNITARIO']);
                    tableRows += `
                        <tr class="text-sm hover:bg-gray-50">
                            <td class="py-2 px-4">${descripcion}${alertaIcon}</td>
                            <td class="py-2 px-4 text-right">${cantidad}</td>
                            <td class="py-2 px-4 text-right">${vrUnitario}</td>
                            <td class="py-2 px-4 text-right">${Utils.formatCurrency(vrTotal)}</td>
                        </tr>
                    `;
                }
            });

            costoDirecto += categorySubtotal;

            contentHTML += `
                <div class="border rounded-lg overflow-hidden">
                    <h4 class="bg-gray-100 px-4 py-2 font-semibold text-gray-700">${catName}</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50"><tr>${tableHeaders}</tr></thead>
                            <tbody class="divide-y divide-gray-200">${tableRows}</tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <td colspan="3" class="py-2 px-4 text-right font-semibold">SUBTOTAL ${catName}</td>
                                    <td class="py-2 px-4 text-right font-semibold">${Utils.formatCurrency(categorySubtotal)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;
        });

        // Cálculos AIU
        const adminValue = costoDirecto * (aiuPcts.admin / 100);
        const imprevValue = costoDirecto * (aiuPcts.imprev / 100);
        const utilValue = costoDirecto * (aiuPcts.util / 100);
        const costoTotalAIU = costoDirecto + adminValue + imprevValue + utilValue;

        contentHTML += `
            <div class="border rounded-lg mt-6">
                <table class="min-w-full text-sm">
                    <tbody class="divide-y divide-gray-200">
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 font-semibold text-right">COSTO DIRECTO</td>
                            <td class="px-4 py-2 text-right font-semibold">${Utils.formatCurrency(costoDirecto)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-right text-gray-600">ADMINISTRACIÓN (${aiuPcts.admin}%)</td>
                            <td class="px-4 py-2 text-right">${Utils.formatCurrency(adminValue)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-right text-gray-600">IMPREVISTOS (${aiuPcts.imprev}%)</td>
                            <td class="px-4 py-2 text-right">${Utils.formatCurrency(imprevValue)}</td>
                        </tr>
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-right text-gray-600">UTILIDAD (${aiuPcts.util}%)</td>
                            <td class="px-4 py-2 text-right">${Utils.formatCurrency(utilValue)}</td>
                        </tr>
                        <tr class="bg-blue-100">
                            <td class="px-4 py-2 text-right font-bold text-blue-800 text-base">VALOR TOTAL APU</td>
                            <td class="px-4 py-2 text-right font-bold text-blue-800 text-base">${Utils.formatCurrency(costoTotalAIU)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;

        // Simulación Monte Carlo si existe
        if (data.simulation) {
            const sim = data.simulation;
            contentHTML += `
                <div class="border rounded-lg mt-6 p-4 bg-gray-50">
                    <h4 class="font-semibold text-center mb-2">Análisis de Riesgo (Simulación Monte Carlo)</h4>
                    <div class="grid grid-cols-3 gap-4 text-center text-sm">
                        <div>
                            <p class="text-gray-500">Costo Esperado (Media)</p>
                            <p class="font-bold">${Utils.formatCurrency(sim.mean)}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Riesgo (Desv. Estándar)</p>
                            <p class="font-bold">${Utils.formatCurrency(sim.std_dev)}</p>
                        </div>
                        <div>
                            <p class="text-gray-500">Rango de Confianza (90%)</p>
                            <p class="font-bold">${Utils.formatCurrency(sim.percentile_5)} - ${Utils.formatCurrency(sim.percentile_95)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        return contentHTML + '</div>';
    }
};

// ============================================================================
// CONTROLADOR DE TABLAS
// ============================================================================
const TableController = {
    /**
     * Actualizar tabla del simulador con jerarquía de tres niveles
     */
    updateSimulatorTable() {
        const tableBody = document.getElementById('presupuesto-table-body');
        if (!tableBody) return;

        const budgetData = StateManager.getState('budgetData');
        const aiuPercentages = StateManager.getState('aiuPercentages');
        const aiuFactor = 1 + ((aiuPercentages.admin + aiuPercentages.imprev + aiuPercentages.util) / 100);
        
        let totalConsolidado = 0;
        tableBody.innerHTML = '';

        // Calcular total consolidado
        budgetData.forEach(item => {
            const valorConstruccionAIU = Utils.sanitizeNumber(item.VALOR_CONSTRUCCION_UN, 0) * aiuFactor;
            totalConsolidado += valorConstruccionAIU * Utils.sanitizeNumber(item.CANTIDAD_PRESUPUESTO, 0);
        });

        // Actualizar display de total
        const totalCostEl = document.getElementById('total-cost');
        if (totalCostEl) {
            totalCostEl.textContent = Utils.formatCurrency(totalConsolidado);
        }

        // Agrupación por tipo de APU
        const apuTypeGroups = this._groupByApuType(budgetData, aiuFactor);
        const sortedApuTypes = Object.keys(apuTypeGroups).sort((a, b) => 
            (CONFIG.APU_TYPE_ORDER[a] || 99) - (CONFIG.APU_TYPE_ORDER[b] || 99)
        );

        // Renderizar jerarquía
        sortedApuTypes.forEach(apuType => {
            this._renderApuTypeGroup(tableBody, apuType, apuTypeGroups[apuType], aiuFactor);
        });
    },

    /**
     * Agrupar por tipo de APU
     */
    _groupByApuType(budgetData, aiuFactor) {
        return budgetData.reduce((acc, item) => {
            const type = item.tipo_apu || 'Indefinido';
            if (!acc[type]) {
                acc[type] = { items: [], subtotal: 0 };
            }
            acc[type].items.push(item);
            const itemCost = Utils.sanitizeNumber(item.VALOR_CONSTRUCCION_UN, 0) * 
                           Utils.sanitizeNumber(item.CANTIDAD_PRESUPUESTO, 0) * aiuFactor;
            acc[type].subtotal += itemCost;
            return acc;
        }, {});
    },

    /**
     * Renderizar grupo de tipo de APU
     */
    _renderApuTypeGroup(tableBody, apuType, groupData, aiuFactor) {
        const typeId = `type-${apuType.replace(/[^a-zA-Z0-9]/g, '-')}`;

        // Header del tipo
        const typeHeaderRow = document.createElement('tr');
        typeHeaderRow.className = 'bg-gray-200 hover:bg-gray-300 cursor-pointer transition-colors';
        typeHeaderRow.onclick = () => {
            document.querySelectorAll(`.${typeId}-child`).forEach(el => {
                el.classList.toggle('hidden');
            });
        };
        typeHeaderRow.innerHTML = `
            <td colspan="5" class="px-4 py-3 text-base font-bold text-gray-800 uppercase">
                ▶ ${Utils.escapeHtml(apuType)}
            </td>
            <td class="px-4 py-3 text-base font-bold text-gray-800 text-right">
                ${Utils.formatCurrency(groupData.subtotal)}
            </td>
            <td class="px-4 py-3 text-sm text-gray-500">-</td>
        `;
        tableBody.appendChild(typeHeaderRow);

        // Agrupar por descripción
        const descriptionGroups = this._groupByDescription(groupData.items);
        const sortedDescriptions = Object.keys(descriptionGroups).sort((a, b) => a.localeCompare(b));

        sortedDescriptions.forEach(groupName => {
            this._renderDescriptionGroup(tableBody, groupName, descriptionGroups[groupName], typeId, aiuFactor);
        });
    },

    /**
     * Agrupar por descripción
     */
    _groupByDescription(items) {
        return items.reduce((acc, item) => {
            const group = item.grupo || 'Ítems Varios';
            if (!acc[group]) acc[group] = [];
            acc[group].push(item);
            return acc;
        }, {});
    },

    /**
     * Renderizar grupo de descripción
     */
    _renderDescriptionGroup(tableBody, groupName, items, typeId, aiuFactor) {
        const groupId = `group-${groupName.replace(/[^a-zA-Z0-9]/g, '-')}`;

        const groupHeaderRow = document.createElement('tr');
        groupHeaderRow.className = `hidden ${typeId}-child bg-blue-100 hover:bg-blue-200 cursor-pointer transition-colors`;
        groupHeaderRow.onclick = (e) => {
            e.stopPropagation();
            document.querySelectorAll(`.${groupId}-item`).forEach(row => {
                row.classList.toggle('hidden');
            });
        };
        groupHeaderRow.innerHTML = `
            <td class="pl-8 pr-4 py-3 text-sm font-bold text-blue-800" colspan="6">
                ▶ ${Utils.escapeHtml(groupName)} (${items.length} ítems)
            </td>
            <td></td>
        `;
        tableBody.appendChild(groupHeaderRow);

        // Renderizar ítems
        items.forEach(item => {
            this._renderItemRow(tableBody, item, typeId, groupId, aiuFactor);
        });
    },

    /**
     * Renderizar fila de ítem
     */
    _renderItemRow(tableBody, item, typeId, groupId, aiuFactor) {
        const valorSuministroAIU = Utils.sanitizeNumber(item.VALOR_SUMINISTRO_UN, 0) * aiuFactor;
        const valorInstalacionAIU = Utils.sanitizeNumber(item.VALOR_INSTALACION_UN, 0) * aiuFactor;
        const valorConstruccionAIU = Utils.sanitizeNumber(item.VALOR_CONSTRUCCION_UN, 0) * aiuFactor;
        
        const tiempo = Utils.sanitizeNumber(item.TIEMPO_INSTALACION, null);
        const tiempoFormateado = tiempo !== null ? `${tiempo.toFixed(4)} Días/Un.` : 'N/A';

        const itemRow = document.createElement('tr');
        itemRow.className = `hidden ${typeId}-child ${groupId}-item hover:bg-gray-50 cursor-pointer transition-colors`;
        itemRow.onclick = (e) => {
            e.stopPropagation();
            ModalManager.open(item.CODIGO_APU);
        };
        
        const alertaIcon = item.alerta ? 
            `<span class="text-yellow-500 ml-1" title="${Utils.escapeHtml(item.alerta)}"> ⚠️</span>` : '';
        
        itemRow.innerHTML = `
            <td class="pl-12 pr-4 py-4 text-sm font-medium text-gray-900">${Utils.escapeHtml(item.CODIGO_APU)}</td>
            <td class="px-4 py-4 text-sm text-gray-500">${Utils.escapeHtml(item.DESCRIPCION_APU)}${alertaIcon}</td>
            <td class="px-4 py-4 text-sm text-gray-500">${Utils.formatCurrency(valorSuministroAIU)}</td>
            <td class="px-4 py-4 text-sm text-gray-500">${Utils.formatCurrency(valorInstalacionAIU)}</td>
            <td class="px-4 py-4 text-sm font-semibold text-gray-700">${Utils.formatCurrency(valorConstruccionAIU)}</td>
            <td class="px-4 py-4 text-sm text-gray-500">${tiempoFormateado}</td>
        `;
        tableBody.appendChild(itemRow);
    },

    /**
     * Actualizar tabla del organizador
     */
    updateOrganizerTable() {
        const tableBody = document.getElementById('organizer-table-body');
        if (!tableBody) return;

        const budgetData = StateManager.getState('budgetData');
        tableBody.innerHTML = '';

        budgetData.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors';
            row.innerHTML = `
                <td class="px-4 py-4 text-sm text-gray-500">${Utils.escapeHtml(item.DESCRIPCION_APU)}</td>
                <td class="px-4 py-4">
                    <input type="text" 
                           value="${Utils.escapeHtml(item.ZONA || '')}" 
                           data-index="${index}" 
                           data-field="ZONA"
                           class="organizer-input w-full p-1 border rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                           placeholder="Ej: ZONA 1">
                </td>
                <td class="px-4 py-4">
                    <input type="text" 
                           value="${Utils.escapeHtml(item.TIPO || '')}" 
                           data-index="${index}" 
                           data-field="TIPO"
                           class="organizer-input w-full p-1 border rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                           placeholder="Ej: CUBIERTA">
                </td>
                <td class="px-4 py-4">
                    <input type="text" 
                           value="${Utils.escapeHtml(item.MATERIAL || '')}" 
                           data-index="${index}" 
                           data-field="MATERIAL"
                           class="organizer-input w-full p-1 border rounded-md text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                           placeholder="Ej: TST">
                </td>
            `;
            tableBody.appendChild(row);
        });

        // Añadir event listeners con debounce
        document.querySelectorAll('.organizer-input').forEach(input => {
            input.addEventListener('input', Utils.debounce((e) => {
                const index = parseInt(e.target.dataset.index);
                const field = e.target.dataset.field;
                const value = e.target.value;
                this._updateItemData(index, field, value);
            }, CONFIG.DEBOUNCE_DELAY));
        });
    },

    /**
     * Actualizar datos de un ítem
     */
    _updateItemData(index, field, value) {
        const budgetData = StateManager.getState('budgetData');
        if (budgetData[index]) {
            budgetData[index][field] = value;
            StateManager.setState({ budgetData });
            SummaryController.updateSummaries();
            Logger.log('Dato actualizado', { index, field, value });
        }
    }
};

// ============================================================================
// CONTROLADOR DE RESÚMENES
// ============================================================================
const SummaryController = {
    /**
     * Actualizar todos los resúmenes
     */
    updateSummaries() {
        const budgetData = StateManager.getState('budgetData');
        const aiuPercentages = StateManager.getState('aiuPercentages');
        const aiuFactor = 1 + ((aiuPercentages.admin + aiuPercentages.imprev + aiuPercentages.util) / 100);
        
        const summaries = { ZONA: {}, TIPO: {}, MATERIAL: {} };

        budgetData.forEach(item => {
            const cost = Utils.sanitizeNumber(item.VALOR_CONSTRUCCION_UN, 0) * 
                        Utils.sanitizeNumber(item.CANTIDAD_PRESUPUESTO, 0) * aiuFactor;
            
            ['ZONA', 'TIPO', 'MATERIAL'].forEach(key => {
                const group = item[key] || 'Sin Asignar';
                summaries[key][group] = (summaries[key][group] || 0) + cost;
            });
        });

        this._renderSummary('summary-zona', 'Resumen por Zona', summaries.ZONA);
        this._renderSummary('summary-tipo', 'Resumen por Tipo', summaries.TIPO);
        this._renderSummary('summary-material', 'Resumen por Material', summaries.MATERIAL);
    },

    /**
     * Renderizar un resumen específico
     */
    _renderSummary(elementId, title, data) {
        const element = document.getElementById(elementId);
        if (!element) return;

        let html = `<h3 class="text-lg font-semibold mb-3 text-gray-700">${title}</h3><div class="space-y-2">`;
        
        const entries = Object.entries(data).filter(([_, value]) => value > 0);
        
        if (entries.length === 0) {
            html += `<p class="text-sm text-gray-500">No hay datos para mostrar.</p>`;
        } else {
            entries.sort((a, b) => b[1] - a[1]).forEach(([key, value]) => {
                html += `
                    <div class="flex justify-between text-sm items-center p-2 hover:bg-gray-50 rounded transition-colors">
                        <span class="text-gray-600 font-medium">${Utils.escapeHtml(key)}</span>
                        <span class="font-semibold text-gray-800">${Utils.formatCurrency(value)}</span>
                    </div>
                `;
            });
        }

        element.innerHTML = html + '</div>';
    }
};

// ============================================================================
// CONTROLADOR DEL ESTIMADOR
// ============================================================================
const EstimatorController = {
    _isInitialized: false,

    /**
     * Inicializar estimador
     */
    initialize() {
        if (this._isInitialized) return;

        this._setupEventListeners();
        this._populateMaterialOptions();
        this._isInitialized = true;
        Logger.log('Estimador inicializado');
    },

    /**
     * Configurar event listeners
     */
    _setupEventListeners() {
        const productoSelect = document.getElementById('est-producto');
        if (productoSelect) {
            productoSelect.addEventListener('change', () => {
                this._populateMaterialOptions();
                this.updateEstimate();
            });
        }

        const estimatorInputs = [
            'est-material', 'est-cuadrilla', 'est-m2', 
            'est-zona', 'est-izaje', 'est-seguridad'
        ];
        
        estimatorInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', () => this.updateEstimate());
                if (element.type === 'number') {
                    element.addEventListener('input', Utils.debounce(() => this.updateEstimate(), CONFIG.DEBOUNCE_DELAY));
                }
            }
        });
    },

    /**
     * Poblar opciones de material según producto
     */
    _populateMaterialOptions() {
        const productoSelect = document.getElementById('est-producto');
        const materialSelect = document.getElementById('est-material');
        
        if (!productoSelect || !materialSelect) return;

        const producto = productoSelect.value;
        const materiales = CONFIG.MATERIAL_MAP[producto] || [];

        materialSelect.innerHTML = '';
        materiales.forEach(material => {
            const option = document.createElement('option');
            option.value = material;
            option.textContent = material;
            materialSelect.appendChild(option);
        });
    },

    /**
     * Actualizar estimación
     */
    async updateEstimate() {
        const rawData = StateManager.getState('rawData');
        if (!rawData || Object.keys(rawData).length === 0) {
            Logger.warn('Intento de actualizar estimación sin datos cargados');
            return;
        }

        const params = this._getEstimatorParams();
        
        // Validar parámetros
        if (!this._validateParams(params)) {
            return;
        }

        const logContainer = document.getElementById('estimator-log-container');
        const logEl = document.getElementById('estimator-log');
        
        if (logContainer) logContainer.classList.remove('hidden');
        if (logEl) logEl.textContent = 'Calculando...';

        try {
            const response = await fetch(CONFIG.API_ENDPOINTS.ESTIMATE, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(params),
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            
            if (logEl) {
                logEl.textContent = result.log || 'No se recibió log del servidor.';
            }

            if (result.error) {
                throw new Error(result.error);
            }

            this._renderResults(result, params.m2);
            Logger.log('Estimación actualizada', { params, result });

        } catch (error) {
            Logger.error('Error al actualizar estimación', error);
            if (logEl) {
                logEl.textContent = `Error: ${error.message}`;
            }
            UIManager.showStatus(`Error en estimación: ${error.message}`, 'error');
        }
    },

    /**
     * Obtener parámetros del estimador
     */
    _getEstimatorParams() {
        return {
            producto: document.getElementById('est-producto')?.value || 'CUBIERTA',
            material: document.getElementById('est-material')?.value || '',
            cuadrilla: document.getElementById('est-cuadrilla')?.value || '5',
            m2: Utils.sanitizeNumber(document.getElementById('est-m2')?.value, 1, 0.01),
            zona: document.getElementById('est-zona')?.value || 'ZONA 0',
            izaje: document.getElementById('est-izaje')?.value || 'MANUAL',
            seguridad: document.getElementById('est-seguridad')?.value || 'NORMAL'
        };
    },

    /**
     * Validar parámetros
     */
    _validateParams(params) {
        if (!params.material) {
            UIManager.showStatus('Seleccione un material', 'warning');
            return false;
        }

        if (params.m2 <= 0) {
            UIManager.showStatus('La cantidad debe ser mayor a 0', 'warning');
            UIManager.shakeElement('est-m2');
            return false;
        }

        return true;
    },

    /**
     * Renderizar resultados
     */
    _renderResults(result, m2) {
        const aiuPercentages = StateManager.getState('aiuPercentages');
        const aiuFactor = 1 + ((aiuPercentages.admin + aiuPercentages.imprev + aiuPercentages.util) / 100);

        const valorSuministro = Utils.sanitizeNumber(result.valor_suministro, 0);
        const valorInstalacion = Utils.sanitizeNumber(result.valor_instalacion, 0);
        const tiempoInstalacion = Utils.sanitizeNumber(result.tiempo_instalacion, 0);

        const valorSuministroAIU = valorSuministro * aiuFactor;
        const valorInstalacionAIU = valorInstalacion * aiuFactor;
        const valorConstruccionAIU = (valorSuministro + valorInstalacion) * aiuFactor;

        const elements = {
            'est-res-suministro': Utils.formatCurrency(valorSuministroAIU),
            'est-res-instalacion': Utils.formatCurrency(valorInstalacionAIU),
            'est-res-construccion': Utils.formatCurrency(valorConstruccionAIU),
            'est-res-tiempo': tiempoInstalacion.toFixed(4)
        };

        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        });
    }
};

// ============================================================================
// CONTROLADOR PRINCIPAL DE LA APLICACIÓN
// ============================================================================
const AppController = {
    /**
     * Procesar archivos cargados
     */
    async procesarArchivos() {
        const presupuestoFile = document.getElementById('presupuesto_file')?.files[0];
        const apusFile = document.getElementById('apus_file')?.files[0];
        const insumosFile = document.getElementById('insumos_file')?.files[0];

        try {
            // Validar archivos
            Utils.validateFile(presupuestoFile);
            Utils.validateFile(apusFile);
            Utils.validateFile(insumosFile);

            UIManager.updateFileStatus('presupuesto', 'success', 'Archivo válido');
            UIManager.updateFileStatus('apus', 'success', 'Archivo válido');
            UIManager.updateFileStatus('insumos', 'success', 'Archivo válido');

        } catch (error) {
            UIManager.showStatus(error.message, 'error');
            Logger.error('Validación de archivos falló', error);
            return;
        }

        const formData = new FormData();
        formData.append('presupuesto', presupuestoFile);
        formData.append('apus', apusFile);
        formData.append('insumos', insumosFile);

        StateManager.setState({ isProcessing: true });
        UIManager.toggleLoader(true);
        UIManager.toggleProcessButton(false);
        UIManager.showStatus("Procesando archivos...", 'info');

        try {
            Logger.log("Iniciando procesamiento de archivos");
            
            const response = await fetch(CONFIG.API_ENDPOINTS.UPLOAD, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });

            Logger.log(`Respuesta del servidor: ${response.status}`);

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error del servidor (${response.status}): ${errorText}`);
            }

            const rawData = await response.json();
            Logger.log("Datos JSON recibidos correctamente");

            if (rawData.error) {
                throw new Error(rawData.error);
            }

            // Validar estructura de datos
            Utils.validateDataStructure(rawData, ['presupuesto']);

            const budgetData = Utils.deepClone(rawData.presupuesto);
            
            StateManager.setState({ rawData, budgetData });

            UIManager.toggleMainContent(true);
            UIManager.showStatus("¡Análisis completado! Ya puedes simular costos y organizar tu proyecto.", 'success');

            this._setupCalculationListeners();
            EstimatorController.initialize();
            this.updateAllCalculations();

            Logger.log("Procesamiento completado exitosamente");

        } catch (error) {
            Logger.error("Error en procesamiento", error);
            UIManager.showStatus(`Error en el procesamiento: ${error.message}`, 'error');
            UIManager.shakeElement('upload-container');
        } finally {
            StateManager.setState({ isProcessing: false });
            UIManager.toggleLoader(false);
            UIManager.toggleProcessButton(true);
        }
    },

    /**
     * Configurar listeners para cálculos
     */
    _setupCalculationListeners() {
        const aiuInputs = ['admin_percent', 'imprev_percent', 'util_percent'];
        
        aiuInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', Utils.debounce((e) => {
                    const value = Utils.sanitizeNumber(
                        e.target.value, 
                        CONFIG.AIU_DEFAULTS[id.replace('_percent', '')],
                        CONFIG.AIU_LIMITS.min,
                        CONFIG.AIU_LIMITS.max
                    );
                    
                    e.target.value = value;
                    
                    const aiuPercentages = StateManager.getState('aiuPercentages');
                    aiuPercentages[id.replace('_percent', '')] = value;
                    StateManager.setState({ aiuPercentages });
                    
                    this.updateAllCalculations();
                }, CONFIG.DEBOUNCE_DELAY));
            }
        });
    },

    /**
     * Actualizar todos los cálculos
     */
    updateAllCalculations() {
        try {
            TableController.updateSimulatorTable();
            TableController.updateOrganizerTable();
            SummaryController.updateSummaries();
            
            if (EstimatorController._isInitialized) {
                EstimatorController.updateEstimate();
            }
        } catch (error) {
            Logger.error('Error al actualizar cálculos', error);
            UIManager.showStatus('Error al actualizar visualización', 'error');
        }
    },

    /**
     * Cambiar pestaña activa
     */
    switchTab(tabName) {
        const validTabs = ['simulador', 'organizador', 'estimador'];
        
        if (!validTabs.includes(tabName)) {
            Logger.warn(`Pestaña inválida: ${tabName}`);
            return;
        }

        // Ocultar todo el contenido
        document.querySelectorAll('.tab-content').forEach(el => {
            el.classList.add('hidden');
            el.setAttribute('aria-hidden', 'true');
        });

        // Mostrar contenido seleccionado
        const contentEl = document.getElementById(`content-${tabName}`);
        if (contentEl) {
            contentEl.classList.remove('hidden');
            contentEl.setAttribute('aria-hidden', 'false');
        }

        // Actualizar tabs
        document.querySelectorAll('nav[role="tablist"] button').forEach(el => {
            el.classList.remove('tab-active');
            el.classList.add('tab-inactive');
            el.setAttribute('aria-selected', 'false');
        });

        const activeTab = document.getElementById(`tab-${tabName}`);
        if (activeTab) {
            activeTab.classList.add('tab-active');
            activeTab.classList.remove('tab-inactive');
            activeTab.setAttribute('aria-selected', 'true');
        }

        StateManager.setState({ currentTab: tabName });
        Logger.log(`Pestaña cambiada a: ${tabName}`);
    }
};

// ============================================================================
// INICIALIZACIÓN
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    Logger.log('Aplicación inicializada');
    
    // Validar elementos críticos del DOM
    const criticalElements = [
        'upload-container', 'main-content', 'loader', 'status',
        'presupuesto_file', 'apus_file', 'insumos_file', 'process-btn'
    ];
    
    const missingElements = criticalElements.filter(id => !document.getElementById(id));
    if (missingElements.length > 0) {
        Logger.error('Elementos críticos faltantes en el DOM', missingElements);
        UIManager.showStatus('Error de inicialización. Recargue la página.', 'error');
    }

    // Suscribirse a cambios de estado para logging
    StateManager.subscribe((newState, prevState) => {
        if (newState.isProcessing !== prevState.isProcessing) {
            Logger.log(`Estado de procesamiento: ${newState.isProcessing}`);
        }
    });

    Logger.log('Sistema listo para uso');
});

// Cerrar modal al hacer clic fuera
document.addEventListener('click', (e) => {
    const modal = document.getElementById('apu-modal');
    if (modal && e.target === modal) {
        ModalManager.close();
    }
});

// Manejo global de errores
window.addEventListener('error', (event) => {
    Logger.error('Error global capturado', event.error);
});

window.addEventListener('unhandledrejection', (event) => {
    Logger.error('Promesa rechazada no manejada', event.reason);
});

</script>
</body>
</html>