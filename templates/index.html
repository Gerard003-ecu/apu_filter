<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APU Filter - Extensión Inteligente para SAGUT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-input-label {
            display: block;
            padding: 10px 15px;
            background-color: #f3f4f6;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease-in-out;
        }
        .file-input-label:hover {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }
        .file-input-label.file-loaded {
            background-color: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }
        .file-input { display: none; }
        #status-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease-in-out;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-success { background-color: #28a745; }
        .toast-error { background-color: #dc3545; }
        .toast-info { background-color: #17a2b8; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="status-container"></div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-gray-900">APU Filter</h1>
            <p class="text-lg text-gray-600 mt-2">Una extensión inteligente para tus reportes de <span class="font-semibold text-blue-600">SAGUT</span></p>
        </header>

        <!-- Sección de Carga de Archivos -->
        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Columna Presupuesto -->
                <div>
                    <h3 class="font-semibold text-lg mb-2">1. Presupuesto</h3>
                    <label for="presupuesto_file" id="presupuesto_label" class="file-input-label">
                        <span>Seleccionar `presupuesto.csv`</span>
                    </label>
                    <input type="file" id="presupuesto_file" class="file-input" accept=".csv" onchange="updateLabel('presupuesto_file', 'presupuesto_label')">
                </div>
                <!-- Columna APUs -->
                <div>
                    <h3 class="font-semibold text-lg mb-2">2. APUs</h3>
                    <label for="apus_file" id="apus_label" class="file-input-label">
                        <span>Seleccionar `apus.csv`</span>
                    </label>
                    <input type="file" id="apus_file" class="file-input" accept=".csv" onchange="updateLabel('apus_file', 'apus_label')">
                </div>
                <!-- Columna Insumos -->
                <div>
                    <h3 class="font-semibold text-lg mb-2">3. Insumos</h3>
                    <label for="insumos_file" id="insumos_label" class="file-input-label">
                        <span>Seleccionar `insumos.csv`</span>
                    </label>
                    <input type="file" id="insumos_file" class="file-input" accept=".csv" onchange="updateLabel('insumos_file', 'insumos_label')">
                </div>
            </div>
            <div class="mt-6 text-center">
                <button onclick="procesarArchivos()" id="process-button" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                    Procesar y Analizar Datos
                </button>
            </div>
        </div>

        <!-- Sección de Resultados (inicialmente oculta) -->
        <div id="results-section" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 hidden">
            <h2 class="text-2xl font-bold mb-6">Resultados del Análisis</h2>
            
            <!-- Filtros y Búsqueda -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <input type="text" id="busqueda_input" placeholder="Buscar por código o descripción..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onkeyup="filtrarYRenderizar()">
                <select id="zona_select" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="filtrarYRenderizar()">
                    <option value="">Todas las Zonas</option>
                </select>
                <div class="bg-gray-100 p-3 rounded-lg text-center">
                    <span class="text-gray-600">Costo Total:</span>
                    <strong id="valor_total" class="text-xl ml-2 text-gray-900">$0</strong>
                </div>
            </div>

            <!-- Tabla de Resultados -->
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Código APU</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Descripción</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Valor Total</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Zona</th>
                        </tr>
                    </thead>
                    <tbody id="resultados_body" class="divide-y divide-gray-200">
                        <!-- Las filas se insertarán aquí dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let fullData = []; // Almacena todos los datos procesados

        function updateLabel(inputId, labelId) {
            const input = document.getElementById(inputId);
            const label = document.getElementById(labelId);
            if (input.files.length > 0) {
                label.classList.add('file-loaded');
                label.querySelector('span').textContent = input.files[0].name;
            } else {
                label.classList.remove('file-loaded');
            }
        }

        async function procesarArchivos() {
            const presupuestoFile = document.getElementById('presupuesto_file').files[0];
            const apusFile = document.getElementById('apus_file').files[0];
            const insumosFile = document.getElementById('insumos_file').files[0];

            if (!presupuestoFile || !apusFile || !insumosFile) {
                showToast('Por favor, selecciona los tres archivos.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('presupuesto', presupuestoFile);
            formData.append('apus', apusFile);
            formData.append('insumos', insumosFile);

            const processButton = document.getElementById('process-button');
            processButton.disabled = true;
            processButton.textContent = 'Procesando...';
            showToast('Procesando archivos, esto puede tardar un momento...', 'info');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                fullData = result.data;
                document.getElementById('results-section').classList.remove('hidden');
                filtrarYRenderizar();
                showToast('¡Archivos procesados con éxito!', 'success');

            } catch (error) {
                console.error('Error al procesar:', error);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                processButton.disabled = false;
                processButton.textContent = 'Procesar y Analizar Datos';
            }
        }

        function filtrarYRenderizar() {
            const busqueda = document.getElementById('busqueda_input').value.toLowerCase();
            const zona = document.getElementById('zona_select').value;
            
            let filteredData = fullData;

            if (busqueda) {
                filteredData = filteredData.filter(item =>
                    item['Código APU'].toLowerCase().includes(busqueda) ||
                    item['Descripción'].toLowerCase().includes(busqueda)
                );
            }

            if (zona) {
                filteredData = filteredData.filter(item => item['Zona'] === zona);
            }

            renderizarTabla(filteredData);
        }

        function renderizarTabla(data) {
            const tablaBody = document.getElementById('resultados_body');
            tablaBody.innerHTML = '';
            let total = 0;

            if (data.length === 0) {
                tablaBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No se encontraron resultados.</td></tr>`;
            } else {
                data.forEach(item => {
                    const valorTotal = parseFloat(item['Valor Total']) || 0;
                    total += valorTotal;
                    const fila = document.createElement('tr');
                    fila.className = 'hover:bg-gray-50';
                    fila.innerHTML = `
                        <td class="py-3 px-4">${item['Código APU']}</td>
                        <td class="py-3 px-4">${item['Descripción']}</td>
                        <td class="py-3 px-4">$${valorTotal.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="py-3 px-4">${item['Zona'] || ''}</td>
                    `;
                    tablaBody.appendChild(fila);
                });
            }

            document.getElementById('valor_total').textContent = `$${total.toLocaleString('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('status-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, 5000);
        }

    </script>
</body>
</html>
