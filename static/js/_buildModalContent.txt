/**
     * ‚ú® REFACTORIZADO: Construir contenido del modal con traducci√≥n y AN√ÅLISIS DE DISCREPANCIA
     */
    _buildModalContent(data) {
        const aiuPcts = StateManager.getState('aiuPercentages');
        let costoDirecto = 0;
        const categoriesBackend = data.desglose || {};
        
        // 1. Traducir y Agrupar (Igual que antes)
        const categoriesTranslated = {};
        for (const [backendKey, items] of Object.entries(categoriesBackend)) {
            if (!Array.isArray(items) || items.length === 0) continue;
            const frontendLabel = Utils.translateCategory(backendKey);
            categoriesTranslated[frontendLabel] = { items: items, backendKey: backendKey };
        }
        
        // 2. Ordenar (Igual que antes)
        const sortedCategories = Object.keys(categoriesTranslated).sort((a, b) => {
            const indexA = CONFIG.CATEGORY_DISPLAY_ORDER.indexOf(a);
            const indexB = CONFIG.CATEGORY_DISPLAY_ORDER.indexOf(b);
            if (indexA !== -1 && indexB !== -1) return indexA - indexB;
            if (indexA !== -1) return -1;
            if (indexB !== -1) return 1;
            return a.localeCompare(b);
        });
        
        let contentHTML = '<div class="space-y-6">';

        // 3. Renderizar Tablas (Igual que antes)
        sortedCategories.forEach(categoryLabel => {
            const categoryData = categoriesTranslated[categoryLabel];
            const categoryItems = categoryData.items;
            let categorySubtotal = 0;
            const isManoObra = categoryLabel.toUpperCase().includes('MANO') || categoryLabel.toUpperCase().includes('OBRA');

            const tableHeaders = isManoObra ? `
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Descripci√≥n</th>
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Jornal Total</th>
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rendimiento</th>
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Valor Total</th>
            ` : `
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Descripci√≥n</th>
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Cantidad</th>
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Vr. Unitario</th>
                <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Valor Total</th>
            `;

            let tableRows = '';
            categoryItems.forEach(item => {
                const vrTotal = Utils.sanitizeNumber(item.valor_total, 0);
                categorySubtotal += vrTotal;
                const alertaIcon = item.alerta ? ` <span class="text-yellow-500" title="${Utils.escapeHtml(item.alerta)}">‚ö†Ô∏è</span>` : '';
                const descripcion = Utils.escapeHtml(item.descripcion || 'Sin descripci√≥n');

                if (isManoObra) {
                    const jornalTotal = Utils.formatCurrency(item.valor_unitario || 0);
                    const rendimiento = Utils.sanitizeNumber(item.RENDIMIENTO || item.rendimiento, 0).toFixed(2);
                    tableRows += `<tr class="text-sm hover:bg-gray-50"><td class="py-2 px-4">${descripcion}${alertaIcon}</td><td class="py-2 px-4 text-right">${jornalTotal}</td><td class="py-2 px-4 text-right">${rendimiento}</td><td class="py-2 px-4 text-right">${Utils.formatCurrency(vrTotal)}</td></tr>`;
                } else {
                    const cantidad = Utils.sanitizeNumber(item.cantidad, 0).toFixed(3);
                    const vrUnitario = Utils.formatCurrency(item.valor_unitario || 0);
                    tableRows += `<tr class="text-sm hover:bg-gray-50"><td class="py-2 px-4">${descripcion}${alertaIcon}</td><td class="py-2 px-4 text-right">${cantidad}</td><td class="py-2 px-4 text-right">${vrUnitario}</td><td class="py-2 px-4 text-right">${Utils.formatCurrency(vrTotal)}</td></tr>`;
                }
            });

            costoDirecto += categorySubtotal;
            contentHTML += `<div class="border rounded-lg overflow-hidden"><h4 class="bg-gray-100 px-4 py-2 font-semibold text-gray-700 flex items-center justify-between"><span>${categoryLabel}</span><span class="text-xs text-gray-500 font-normal">${categoryItems.length} √≠tem(s)</span></h4><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-gray-50"><tr>${tableHeaders}</tr></thead><tbody class="divide-y divide-gray-200">${tableRows}</tbody><tfoot class="bg-gray-100"><tr><td colspan="3" class="py-2 px-4 text-right font-semibold">SUBTOTAL ${categoryLabel}</td><td class="py-2 px-4 text-right font-semibold">${Utils.formatCurrency(categorySubtotal)}</td></tr></tfoot></table></div></div>`;
        });

        // 4. Tabla de Resumen AIU (Igual que antes)
        const adminValue = costoDirecto * (aiuPcts.admin / 100);
        const imprevValue = costoDirecto * (aiuPcts.imprev / 100);
        const utilValue = costoDirecto * (aiuPcts.util / 100);
        const costoTotalAIU = costoDirecto + adminValue + imprevValue + utilValue;

        contentHTML += `<div class="border rounded-lg mt-6"><table class="min-w-full text-sm"><tbody class="divide-y divide-gray-200"><tr class="hover:bg-gray-50"><td class="px-4 py-2 font-semibold text-right">COSTO DIRECTO</td><td class="px-4 py-2 text-right font-semibold">${Utils.formatCurrency(costoDirecto)}</td></tr><tr class="hover:bg-gray-50"><td class="px-4 py-2 text-right text-gray-600">ADMINISTRACI√ìN (${aiuPcts.admin}%)</td><td class="px-4 py-2 text-right">${Utils.formatCurrency(adminValue)}</td></tr><tr class="hover:bg-gray-50"><td class="px-4 py-2 text-right text-gray-600">IMPREVISTOS (${aiuPcts.imprev}%)</td><td class="px-4 py-2 text-right">${Utils.formatCurrency(imprevValue)}</td></tr><tr class="hover:bg-gray-50"><td class="px-4 py-2 text-right text-gray-600">UTILIDAD (${aiuPcts.util}%)</td><td class="px-4 py-2 text-right">${Utils.formatCurrency(utilValue)}</td></tr><tr class="bg-blue-100"><td class="px-4 py-2 text-right font-bold text-blue-800 text-base">VALOR TOTAL APU</td><td class="px-4 py-2 text-right font-bold text-blue-800 text-base">${Utils.formatCurrency(costoTotalAIU)}</td></tr></tbody></table></div>`;

        // 5. Simulaci√≥n Monte Carlo con CAJA DE INSIGHTS
        if (data.simulation) {
            const sim = data.simulation;
            
            // --- L√ìGICA DE INSIGHTS ---
            const diff = sim.mean - costoDirecto;
            const diffPercent = costoDirecto > 0 ? (diff / costoDirecto) * 100 : 0;
            const discardedItems = sim.metadata?.discarded_items || 0;
            
            let insightHTML = '';
            let insightClass = '';
            let insightIcon = '';

            if (Math.abs(diffPercent) < 1.0) {
                // Diferencia despreciable (< 1%)
                insightClass = 'bg-green-50 text-green-800 border-green-200';
                insightIcon = '‚úÖ';
                insightHTML = `<strong>Consistencia Alta:</strong> El modelo probabil√≠stico valida el costo directo.`;
            } else if (diff > 0) {
                // Monte Carlo > Costo Directo (Riesgo)
                insightClass = 'bg-orange-50 text-orange-800 border-orange-200';
                insightIcon = 'üìà';
                insightHTML = `<strong>Alerta de Riesgo:</strong> El modelo proyecta un sobrecosto probable del <strong>${diffPercent.toFixed(1)}%</strong> debido a la volatilidad hist√≥rica de los insumos.`;
            } else {
                // Monte Carlo < Costo Directo (Ahorro o Exclusi√≥n)
                insightClass = 'bg-blue-50 text-blue-800 border-blue-200';
                insightIcon = 'üìâ';
                
                if (discardedItems > 0) {
                    insightHTML = `<strong>An√°lisis de Datos:</strong> El modelo es menor porque <strong>${discardedItems} √≠tems</strong> at√≠picos o con valores extremos fueron excluidos para normalizar la estad√≠stica.`;
                } else {
                    insightHTML = `<strong>Proyecci√≥n Favorable:</strong> El modelo sugiere una posible optimizaci√≥n del <strong>${Math.abs(diffPercent).toFixed(1)}%</strong> en un escenario conservador.`;
                }
            }

            contentHTML += `
                <div class="border rounded-lg mt-6 p-4 bg-gray-50">
                    <h4 class="font-semibold text-center mb-4 text-gray-700">An√°lisis de Riesgo (Simulaci√≥n Monte Carlo)</h4>
                    
                    <div class="grid grid-cols-3 gap-4 text-center text-sm mb-4">
                        <div class="p-2 bg-white rounded shadow-sm">
                            <p class="text-gray-500 text-xs uppercase tracking-wide">Costo Esperado (Media)</p>
                            <p class="font-bold text-lg text-gray-800">${Utils.formatCurrency(sim.mean)}</p>
                        </div>
                        <div class="p-2 bg-white rounded shadow-sm">
                            <p class="text-gray-500 text-xs uppercase tracking-wide">Riesgo (Desv. Est√°ndar)</p>
                            <p class="font-bold text-lg text-gray-800">${Utils.formatCurrency(sim.std_dev)}</p>
                        </div>
                        <div class="p-2 bg-white rounded shadow-sm">
                            <p class="text-gray-500 text-xs uppercase tracking-wide">Rango Confianza (90%)</p>
                            <p class="font-bold text-sm text-gray-800 mt-1">${Utils.formatCurrency(sim.percentile_5)} - ${Utils.formatCurrency(sim.percentile_95)}</p>
                        </div>
                    </div>

                    <!-- CAJA DE INSIGHTS -->
                    <div class="border-l-4 p-3 text-sm ${insightClass} rounded-r">
                        <div class="flex items-start">
                            <span class="text-lg mr-2">${insightIcon}</span>
                            <div>${insightHTML}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        return contentHTML + '</div>';
    }