================================================ test session starts =================================================
platform linux -- Python 3.10.19, pytest-8.4.2, pluggy-1.6.0 -- /home/gerardo/miniconda3/envs/ap_filter_env/bin/python
cachedir: .pytest_cache
rootdir: /home/gerardo/Documentos/GitHub/apu_filter
configfile: pyproject.toml
collected 46 items                                                                                                   

tests/test_apu_processor.py::TestEnumsAndConstants::test_excluded_terms_immutable PASSED                       [  2%]
tests/test_apu_processor.py::TestEnumsAndConstants::test_formato_linea_enum PASSED                             [  4%]
tests/test_apu_processor.py::TestEnumsAndConstants::test_tipo_insumo_enum PASSED                               [  6%]
tests/test_apu_processor.py::TestKeywordCache::test_all_keyword_categories PASSED                              [  8%]
tests/test_apu_processor.py::TestKeywordCache::test_lazy_initialization PASSED                                 [ 10%]
tests/test_apu_processor.py::TestKeywordCache::test_no_duplicate_keywords PASSED                               [ 13%]
tests/test_apu_processor.py::TestAPUTransformer::test_build_insumo_basico_variations FAILED                    [ 15%]
tests/test_apu_processor.py::TestAPUTransformer::test_build_mo_completa_failure_cases PASSED                   [ 17%]
tests/test_apu_processor.py::TestAPUTransformer::test_build_mo_completa_success FAILED                         [ 19%]
tests/test_apu_processor.py::TestAPUTransformer::test_classify_insumo_with_cache FAILED                        [ 21%]
tests/test_apu_processor.py::TestAPUTransformer::test_clean_token_variations PASSED                            [ 23%]
tests/test_apu_processor.py::TestAPUTransformer::test_correct_total_value PASSED                               [ 26%]
tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_ignores_junk_lines PASSED                  [ 28%]
tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_0 FAILED                         [ 30%]
tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_1 PASSED                         [ 32%]
tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_2 PASSED                         [ 34%]
tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_3 PASSED                         [ 36%]
tests/test_apu_processor.py::TestAPUTransformer::test_parse_insumo_fields_handles_comma_decimals PASSED        [ 39%]
tests/test_apu_processor.py::TestAPUTransformer::test_parse_insumo_fields_with_waste FAILED                    [ 41%]
tests/test_apu_processor.py::TestAPUTransformer::test_special_cases_classification PASSED                      [ 43%]
tests/test_apu_processor.py::TestAPUTransformer::test_validate_mo_format FAILED                                [ 45%]
tests/test_apu_processor.py::TestAPUProcessor::test_batch_processing FAILED                                    [ 47%]
tests/test_apu_processor.py::TestAPUProcessor::test_build_optimized_dataframe PASSED                           [ 50%]
tests/test_apu_processor.py::TestAPUProcessor::test_clean_record_fields PASSED                                 [ 52%]
tests/test_apu_processor.py::TestAPUProcessor::test_fix_mo_values FAILED                                       [ 54%]
tests/test_apu_processor.py::TestAPUProcessor::test_fix_squad_units PASSED                                     [ 56%]
tests/test_apu_processor.py::TestAPUProcessor::test_handle_duplicates PASSED                                   [ 58%]
tests/test_apu_processor.py::TestAPUProcessor::test_infer_unit_intelligent PASSED                              [ 60%]
tests/test_apu_processor.py::TestAPUProcessor::test_initialization_invalid_inputs PASSED                       [ 63%]
tests/test_apu_processor.py::TestAPUProcessor::test_initialization_valid PASSED                                [ 65%]
tests/test_apu_processor.py::TestAPUProcessor::test_initialization_with_warnings PASSED                        [ 67%]
tests/test_apu_processor.py::TestAPUProcessor::test_normalize_unit_cache PASSED                                [ 69%]
tests/test_apu_processor.py::TestAPUProcessor::test_process_all_basic FAILED                                   [ 71%]
tests/test_apu_processor.py::TestAPUProcessor::test_process_edge_cases PASSED                                  [ 73%]
tests/test_apu_processor.py::TestAPUProcessor::test_validate_by_type PASSED                                    [ 76%]
tests/test_apu_processor.py::TestAPUProcessor::test_validate_final_insumo PASSED                               [ 78%]
tests/test_apu_processor.py::TestUtilityFunctions::test_calculate_unit_costs_basic PASSED                      [ 80%]
tests/test_apu_processor.py::TestUtilityFunctions::test_calculate_unit_costs_empty_df PASSED                   [ 82%]
tests/test_apu_processor.py::TestUtilityFunctions::test_calculate_unit_costs_missing_columns PASSED            [ 84%]
tests/test_apu_processor.py::TestUtilityFunctions::test_calculate_unit_costs_zero_division PASSED              [ 86%]
tests/test_apu_processor.py::TestIntegration::test_error_recovery FAILED                                       [ 89%]
tests/test_apu_processor.py::TestIntegration::test_full_pipeline FAILED                                        [ 91%]
tests/test_apu_processor.py::TestIntegration::test_large_dataset_performance FAILED                            [ 93%]
tests/test_apu_processor.py::TestRegression::test_scientific_notation PASSED                                   [ 95%]
tests/test_apu_processor.py::TestRegression::test_unicode_handling PASSED                                      [ 97%]
tests/test_apu_processor.py::TestRegression::test_very_long_descriptions PASSED                                [100%]

====================================================== FAILURES ======================================================
_______________________________ TestAPUTransformer.test_build_insumo_basico_variations _______________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_build_insumo_basico_variations>

    def test_build_insumo_basico_variations(self):
        """Prueba construcción de insumos básicos con variaciones."""
        test_cases = [
            # (tokens, tipo_esperado)
            (["Tubería PVC", "M", "10", "5000", "50000"], Suministro),
            (["Retroexcavadora", "HR", "2", "150000", "300000"], Equipo),
            (["Transporte material", "VIAJE", "1", "200000", "200000"], Transporte),
            (["Otro insumo", "UND", "5", "1000", "5000"], Otro),
        ]
    
        for tokens, expected_class in test_cases:
            with self.subTest(tokens=tokens):
                result = self.transformer._build_insumo_basico(tokens)
>               self.assertIsInstance(result, expected_class)
E               AssertionError: Otro(codigo_apu='TEST-001', descripcion_apu='TEST APU', unidad_apu='UNIDAD', descripcion_insumo='TUBERIA PVC', unidad_insumo='M', cantidad=10.0, precio_unitario=5000.0, valor_total=50000.0, categoria='TEST', formato_origen='INSUMO_BASICO', tipo_insumo='OTRO', normalized_desc='tuberia pvc', rendimiento=10.0) is not an instance of <class 'app.schemas.Suministro'>

tests/test_apu_processor.py:345: AssertionError
_________________________________ TestAPUTransformer.test_build_mo_completa_success __________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_build_mo_completa_success>

    def test_build_mo_completa_success(self):
        """Prueba construcción exitosa de ManoDeObra."""
        tokens = ["Oficial albañil", "JOR", "1", "150000", "10.0", "15000"]
        result = self.transformer._build_mo_completa(tokens)
    
>       self.assertIsInstance(result, ManoDeObra)
E       AssertionError: None is not an instance of <class 'app.schemas.ManoDeObra'>

tests/test_apu_processor.py:315: AssertionError
------------------------------------------------- Captured log call --------------------------------------------------
WARNING  app.apu_processor:apu_processor.py:620 Valores MO fuera de rango: jornal=10, rendimiento=1.000 (rango jornal: 1,000-10,000,000, rango rendimiento: 0.0001-10000)
_________________________________ TestAPUTransformer.test_classify_insumo_with_cache _________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_classify_insumo_with_cache>

    def test_classify_insumo_with_cache(self):
        """Prueba clasificación con cache."""
        descriptions = [
            ("Oficial de construcción", TipoInsumo.MANO_DE_OBRA),
            ("Retroexcavadora CAT", TipoInsumo.EQUIPO),
            ("Transporte de agregados", TipoInsumo.TRANSPORTE),
            ("Tubería PVC 4\"", TipoInsumo.SUMINISTRO),
            ("Elemento desconocido", TipoInsumo.OTRO),
        ]
    
        for desc, expected_tipo in descriptions:
            with self.subTest(desc=desc):
                result = self.transformer._classify_insumo_with_cache(desc)
>               self.assertEqual(result, expected_tipo)
E               AssertionError: <TipoInsumo.OTRO: 'OTRO'> != <TipoInsumo.SUMINISTRO: 'SUMINISTRO'>

tests/test_apu_processor.py:390: AssertionError
_________________________________ TestAPUTransformer.test_detect_format_scenarios_0 __________________________________

a = (<tests.test_apu_processor.TestAPUTransformer testMethod=test_detect_format_scenarios_0>,), kw = {}

    @wraps(func)
    def standalone_func(*a, **kw):
>       return func(*(a + p.args), **p.kwargs, **kw)

../../../miniconda3/envs/ap_filter_env/lib/python3.10/site-packages/parameterized/parameterized.py:620: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/test_apu_processor.py:290: in test_detect_format_scenarios
    self.assertEqual(detected, expected_format)
E   AssertionError: <FormatoLinea.INSUMO_BASICO: 'INSUMO_BASICO'> != <FormatoLinea.MO_COMPLETA: 'MO_COMPLETA'>
_______________________________ TestAPUTransformer.test_parse_insumo_fields_with_waste _______________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_parse_insumo_fields_with_waste>

    def test_parse_insumo_fields_with_waste(self):
        """Prueba parsing de campos con desperdicio (6 campos)."""
        # Con desperdicio
        tokens_6 = ["Concreto", "M3", "1.05", "5%", "380000", "399000"]
        result = self.transformer._parse_insumo_fields(tokens_6)
        self.assertIsNotNone(result)
        desc, unit, qty, price, total = result
        self.assertEqual(desc, "Concreto")
        self.assertEqual(unit, "M3")
>       self.assertAlmostEqual(qty, 1.05)
E       AssertionError: 105.0 != 1.05 within 7 places (103.95 difference)

tests/test_apu_processor.py:356: AssertionError
_____________________________________ TestAPUTransformer.test_validate_mo_format _____________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_validate_mo_format>

    def test_validate_mo_format(self):
        """Prueba validación específica de formato MO."""
        # Caso válido
        valid_fields = ["Oficial", "JOR", "1", "120000", "8.0", "15000"]
>       self.assertTrue(self.transformer._validate_mo_format(valid_fields))
E       AssertionError: False is not true

tests/test_apu_processor.py:296: AssertionError
_______________________________________ TestAPUProcessor.test_batch_processing _______________________________________

self = <tests.test_apu_processor.TestAPUProcessor testMethod=test_batch_processing>

    def test_batch_processing(self):
        """Prueba procesamiento por lotes."""
        # Crear muchos registros
        many_records = self.sample_records * 50  # 250 registros
        config_with_batch = self.config.copy()
        config_with_batch['batch_size'] = 50
    
        with suppress_logs():
            processor = APUProcessor(many_records, config_with_batch)
            df = processor.process_all()
    
            self.assertIsInstance(df, pd.DataFrame)
            # Verificar que procesó múltiples lotes
>           self.assertGreaterEqual(len(df), 50)
E           AssertionError: 0 not greater than or equal to 50

tests/test_apu_processor.py:515: AssertionError
________________________________________ TestAPUProcessor.test_fix_mo_values _________________________________________

self = <tests.test_apu_processor.TestAPUProcessor testMethod=test_fix_mo_values>

    def test_fix_mo_values(self):
        """Prueba la corrección de valores inconsistentes en Mano de Obra."""
        processor = APUProcessor([], self.config)
        inconsistent_mo = ManoDeObra(
            descripcion_insumo="Oficial",
            cantidad=0,  # Cantidad incorrecta
            precio_unitario=0,  # Precio incorrecto
            valor_total=120000,
            rendimiento=10.0,  # Rendimiento correcto
            tipo_insumo="MANO_DE_OBRA",
            # ... otros campos necesarios
            codigo_apu="TEST-MO",
            descripcion_apu="Test MO Fix",
            unidad_apu="UND",
            unidad_insumo="JOR",
            categoria="MANO DE OBRA",
            formato_origen="INSUMO_BASICO",
            normalized_desc="oficial"
        )
        processor.processed_data.append(inconsistent_mo)
    
        processor._fix_mo_values()
    
        fixed_mo = processor.processed_data[0]
        self.assertGreater(fixed_mo.cantidad, 0)
        self.assertAlmostEqual(fixed_mo.cantidad, 1.0 / 10.0)
>       self.assertGreater(fixed_mo.precio_unitario, 0)
E       AssertionError: 0 not greater than 0

tests/test_apu_processor.py:730: AssertionError
------------------------------------------------- Captured log call --------------------------------------------------
WARNING  app.apu_processor:apu_processor.py:717 Lista de registros vacía
______________________________________ TestAPUProcessor.test_process_all_basic _______________________________________

self = <tests.test_apu_processor.TestAPUProcessor testMethod=test_process_all_basic>

    def test_process_all_basic(self):
        """Prueba procesamiento básico completo."""
        processor = APUProcessor(self.sample_records, self.config)
        df = processor.process_all()
    
        self.assertIsInstance(df, pd.DataFrame)
>       self.assertGreater(len(df), 0)
E       AssertionError: 0 not greater than 0

tests/test_apu_processor.py:475: AssertionError
------------------------------------------------- Captured log call --------------------------------------------------
WARNING  app.apu_processor:apu_processor.py:1285 ⚠️ No hay datos para construir DataFrame
________________________________________ TestIntegration.test_error_recovery _________________________________________

self = <tests.test_apu_processor.TestIntegration testMethod=test_error_recovery>

    def test_error_recovery(self):
        """Prueba recuperación de errores durante procesamiento."""
        # Mix de registros buenos y malos
        mixed_records = (
            TestFixtures.get_sample_records() +
            TestFixtures.get_edge_case_records()
        )
    
        config = TestFixtures.get_default_config()
    
        with suppress_logs():
            processor = APUProcessor(mixed_records, config)
            df = processor.process_all()
    
            # Debe procesar sin crashes
            self.assertIsInstance(df, pd.DataFrame)
    
            # Debe haber procesado al menos los registros válidos
>           self.assertGreater(len(df), 0)
E           AssertionError: 0 not greater than 0

tests/test_apu_processor.py:891: AssertionError
_________________________________________ TestIntegration.test_full_pipeline _________________________________________

self = <tests.test_apu_processor.TestIntegration testMethod=test_full_pipeline>

    def test_full_pipeline(self):
        """Prueba pipeline completo desde registros crudos hasta costos unitarios."""
        with suppress_logs():
            # Datos de entrada
            raw_records = TestFixtures.get_sample_records()
            config = TestFixtures.get_default_config()
    
            # Procesar
            processor = APUProcessor(raw_records, config)
            df_processed = processor.process_all()
    
            # Validar procesamiento
>           self.assertGreater(len(df_processed), 0)
E           AssertionError: 0 not greater than 0

tests/test_apu_processor.py:841: AssertionError
___________________________________ TestIntegration.test_large_dataset_performance ___________________________________

self = <tests.test_apu_processor.TestIntegration testMethod=test_large_dataset_performance>

    def test_large_dataset_performance(self):
        """Prueba performance con dataset grande."""
        # Generar dataset grande
        base_records = TestFixtures.get_sample_records()
        large_dataset = base_records * 200  # 1000 registros
    
        config = TestFixtures.get_default_config()
        config['batch_size'] = 100
    
        with suppress_logs():
            start_time = time.time()
            processor = APUProcessor(large_dataset, config)
            df = processor.process_all()
            elapsed = time.time() - start_time
    
            # Debe procesar en tiempo razonable (< 10 segundos para 1000 registros)
            self.assertLess(elapsed, 10, f"Procesamiento muy lento: {elapsed:.2f}s")
    
            # Debe procesar al menos 50% de los registros
>           self.assertGreater(len(df), len(large_dataset) * 0.5)
E           AssertionError: 0 not greater than 700.0

tests/test_apu_processor.py:871: AssertionError
================================================== warnings summary ==================================================
tests/test_apu_processor.py::TestAPUTransformer::test_build_insumo_basico_variations
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:294: UserWarning: Inconsistencia: tipo_insumo='OTRO' pero categoria='TEST'. Se recomienda alinear ambos campos.
    super()._validate_consistency()

tests/test_apu_processor.py::TestAPUProcessor::test_fix_mo_values
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:90: UserWarning: valor_total (120000) no coincide con cantidad (0) * precio_unitario (0). Valor esperado: 0.0000. Considerar ajuste.
    self._validate_required_fields()

tests/test_apu_processor.py::TestAPUProcessor::test_fix_mo_values
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:162: UserWarning: Inconsistencia: tipo_insumo='MANO_DE_OBRA' pero categoria='MANO DE OBRA'. Se recomienda alinear ambos campos.
    super()._validate_consistency()

tests/test_apu_processor.py::TestAPUProcessor::test_fix_mo_values
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:91: UserWarning: Mano de Obra: rendimiento=10.0 sugiere cantidad≈0.1000, pero cantidad=0. Posible error de entrada.
    self._validate_consistency()

tests/test_apu_processor.py::TestAPUProcessor::test_fix_mo_values
tests/test_apu_processor.py::TestAPUProcessor::test_fix_squad_units
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:91: UserWarning: Mano de Obra: unidades 'UNIDAD' o 'JOR' no son típicas. Unidades esperadas: {'MES', 'DIA', 'SEMANA', 'HORA'}
    self._validate_consistency()

tests/test_apu_processor.py::TestAPUProcessor::test_fix_squad_units
tests/test_apu_processor.py::TestAPUProcessor::test_handle_duplicates
tests/test_apu_processor.py::TestAPUProcessor::test_validate_by_type
tests/test_apu_processor.py::TestAPUProcessor::test_validate_final_insumo
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:162: UserWarning: Inconsistencia: tipo_insumo='MANO_DE_OBRA' pero categoria='MO'. Se recomienda alinear ambos campos.
    super()._validate_consistency()

tests/test_apu_processor.py::TestAPUProcessor::test_fix_squad_units
tests/test_apu_processor.py::TestAPUProcessor::test_handle_duplicates
tests/test_apu_processor.py::TestAPUProcessor::test_validate_by_type
tests/test_apu_processor.py::TestAPUProcessor::test_validate_final_insumo
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:91: UserWarning: Mano de Obra: unidades 'JOR' o 'JOR' no son típicas. Unidades esperadas: {'MES', 'DIA', 'SEMANA', 'HORA'}
    self._validate_consistency()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
============================================== short test summary info ===============================================
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_build_insumo_basico_variations - AssertionError: Otro(codigo_apu='TEST-001', descripcion_apu='TEST APU', unidad_apu='UNIDAD', descripcion_insumo='TUBERIA PVC', unidad_insumo='M', cantidad=10.0, precio_unitario=5000.0, valor_total=50000.0, categoria='TEST', formato_origen='INSUMO_BASICO', tipo_insumo='OTRO', normalized_desc='tuberia pvc', rendimiento=10.0) is not an instance of <class 'app.schemas.Suministro'>
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_build_mo_completa_success - AssertionError: None is not an instance of <class 'app.schemas.ManoDeObra'>
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_classify_insumo_with_cache - AssertionError: <TipoInsumo.OTRO: 'OTRO'> != <TipoInsumo.SUMINISTRO: 'SUMINISTRO'>
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_0 - AssertionError: <FormatoLinea.INSUMO_BASICO: 'INSUMO_BASICO'> != <FormatoLinea.MO_COMPLETA: 'MO_COMPLETA'>
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_parse_insumo_fields_with_waste - AssertionError: 105.0 != 1.05 within 7 places (103.95 difference)
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_validate_mo_format - AssertionError: False is not true
FAILED tests/test_apu_processor.py::TestAPUProcessor::test_batch_processing - AssertionError: 0 not greater than or equal to 50
FAILED tests/test_apu_processor.py::TestAPUProcessor::test_fix_mo_values - AssertionError: 0 not greater than 0
FAILED tests/test_apu_processor.py::TestAPUProcessor::test_process_all_basic - AssertionError: 0 not greater than 0
FAILED tests/test_apu_processor.py::TestIntegration::test_error_recovery - AssertionError: 0 not greater than 0
FAILED tests/test_apu_processor.py::TestIntegration::test_full_pipeline - AssertionError: 0 not greater than 0
FAILED tests/test_apu_processor.py::TestIntegration::test_large_dataset_performance - AssertionError: 0 not greater than 700.0
===================================== 12 failed, 34 passed, 14 warnings in 5.67s =====================================