
(ap_filter_env) gerardo@gerardo-Satellite-C845:~/Documentos/GitHub/apu_filter$ python -m pytest tests/test_apu_processor.py -vv
================================================ test session starts =================================================
platform linux -- Python 3.10.19, pytest-8.4.2, pluggy-1.6.0 -- /home/gerardo/miniconda3/envs/ap_filter_env/bin/python
cachedir: .pytest_cache
rootdir: /home/gerardo/Documentos/GitHub/apu_filter
configfile: pyproject.toml
collected 43 items                                                                                                   

tests/test_apu_processor.py::TestEnumsAndConstants::test_excluded_terms_immutable PASSED                       [  2%]
tests/test_apu_processor.py::TestEnumsAndConstants::test_formato_linea_enum PASSED                             [  4%]
tests/test_apu_processor.py::TestEnumsAndConstants::test_tipo_insumo_enum PASSED                               [  6%]
tests/test_apu_processor.py::TestKeywordCache::test_all_keyword_categories FAILED                              [  9%]
tests/test_apu_processor.py::TestKeywordCache::test_lazy_initialization FAILED                                 [ 11%]
tests/test_apu_processor.py::TestKeywordCache::test_no_duplicate_keywords FAILED                               [ 13%]
tests/test_apu_processor.py::TestAPUTransformer::test_build_insumo_basico_variations FAILED                    [ 16%]
tests/test_apu_processor.py::TestAPUTransformer::test_build_mo_completa_failure_cases FAILED                   [ 18%]
tests/test_apu_processor.py::TestAPUTransformer::test_build_mo_completa_success FAILED                         [ 20%]
tests/test_apu_processor.py::TestAPUTransformer::test_classify_insumo_with_cache FAILED                        [ 23%]
tests/test_apu_processor.py::TestAPUTransformer::test_clean_token_variations FAILED                            [ 25%]
tests/test_apu_processor.py::TestAPUTransformer::test_correct_total_value FAILED                               [ 27%]
tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_0 FAILED                         [ 30%]
tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_1 FAILED                         [ 32%]
tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_2 FAILED                         [ 34%]
tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_3 FAILED                         [ 37%]
tests/test_apu_processor.py::TestAPUTransformer::test_parse_insumo_fields_with_waste FAILED                    [ 39%]
tests/test_apu_processor.py::TestAPUTransformer::test_special_cases_classification FAILED                      [ 41%]
tests/test_apu_processor.py::TestAPUTransformer::test_validate_mo_format FAILED                                [ 44%]
tests/test_apu_processor.py::TestAPUProcessor::test_batch_processing FAILED                                    [ 46%]
tests/test_apu_processor.py::TestAPUProcessor::test_build_optimized_dataframe PASSED                           [ 48%]
tests/test_apu_processor.py::TestAPUProcessor::test_clean_record_fields FAILED                                 [ 51%]
tests/test_apu_processor.py::TestAPUProcessor::test_fix_squad_units PASSED                                     [ 53%]
tests/test_apu_processor.py::TestAPUProcessor::test_handle_duplicates PASSED                                   [ 55%]
tests/test_apu_processor.py::TestAPUProcessor::test_infer_unit_intelligent FAILED                              [ 58%]
tests/test_apu_processor.py::TestAPUProcessor::test_initialization_invalid_inputs PASSED                       [ 60%]
tests/test_apu_processor.py::TestAPUProcessor::test_initialization_valid PASSED                                [ 62%]
tests/test_apu_processor.py::TestAPUProcessor::test_initialization_with_warnings PASSED                        [ 65%]
tests/test_apu_processor.py::TestAPUProcessor::test_normalize_unit_cache FAILED                                [ 67%]
tests/test_apu_processor.py::TestAPUProcessor::test_process_all_basic FAILED                                   [ 69%]
tests/test_apu_processor.py::TestAPUProcessor::test_process_edge_cases PASSED                                  [ 72%]
tests/test_apu_processor.py::TestAPUProcessor::test_validate_by_type PASSED                                    [ 74%]
tests/test_apu_processor.py::TestAPUProcessor::test_validate_final_insumo PASSED                               [ 76%]
tests/test_apu_processor.py::TestUtilityFunctions::test_calculate_unit_costs_basic PASSED                      [ 79%]
tests/test_apu_processor.py::TestUtilityFunctions::test_calculate_unit_costs_empty_df PASSED                   [ 81%]
tests/test_apu_processor.py::TestUtilityFunctions::test_calculate_unit_costs_missing_columns PASSED            [ 83%]
tests/test_apu_processor.py::TestUtilityFunctions::test_calculate_unit_costs_zero_division PASSED              [ 86%]
tests/test_apu_processor.py::TestIntegration::test_error_recovery FAILED                                       [ 88%]
tests/test_apu_processor.py::TestIntegration::test_full_pipeline FAILED                                        [ 90%]
tests/test_apu_processor.py::TestIntegration::test_large_dataset_performance FAILED                            [ 93%]
tests/test_apu_processor.py::TestRegression::test_scientific_notation PASSED                                   [ 95%]
tests/test_apu_processor.py::TestRegression::test_unicode_handling PASSED                                      [ 97%]
tests/test_apu_processor.py::TestRegression::test_very_long_descriptions PASSED                                [100%]

====================================================== FAILURES ======================================================
____________________________________ TestKeywordCache.test_all_keyword_categories ____________________________________

self = <tests.test_apu_processor.TestKeywordCache testMethod=test_all_keyword_categories>

    def setUp(self):
>       self.cache = KeywordCache()
E       TypeError: KeywordCache.__init__() missing 1 required positional argument: 'config'

tests/test_apu_processor.py:194: TypeError
_____________________________________ TestKeywordCache.test_lazy_initialization ______________________________________

self = <tests.test_apu_processor.TestKeywordCache testMethod=test_lazy_initialization>

    def setUp(self):
>       self.cache = KeywordCache()
E       TypeError: KeywordCache.__init__() missing 1 required positional argument: 'config'

tests/test_apu_processor.py:194: TypeError
____________________________________ TestKeywordCache.test_no_duplicate_keywords _____________________________________

self = <tests.test_apu_processor.TestKeywordCache testMethod=test_no_duplicate_keywords>

    def setUp(self):
>       self.cache = KeywordCache()
E       TypeError: KeywordCache.__init__() missing 1 required positional argument: 'config'

tests/test_apu_processor.py:194: TypeError
_______________________________ TestAPUTransformer.test_build_insumo_basico_variations _______________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_build_insumo_basico_variations>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
______________________________ TestAPUTransformer.test_build_mo_completa_failure_cases _______________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_build_mo_completa_failure_cases>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
_________________________________ TestAPUTransformer.test_build_mo_completa_success __________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_build_mo_completa_success>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
_________________________________ TestAPUTransformer.test_classify_insumo_with_cache _________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_classify_insumo_with_cache>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
___________________________________ TestAPUTransformer.test_clean_token_variations ___________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_clean_token_variations>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
____________________________________ TestAPUTransformer.test_correct_total_value _____________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_correct_total_value>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
_________________________________ TestAPUTransformer.test_detect_format_scenarios_0 __________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_detect_format_scenarios_0>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
_________________________________ TestAPUTransformer.test_detect_format_scenarios_1 __________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_detect_format_scenarios_1>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
_________________________________ TestAPUTransformer.test_detect_format_scenarios_2 __________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_detect_format_scenarios_2>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
_________________________________ TestAPUTransformer.test_detect_format_scenarios_3 __________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_detect_format_scenarios_3>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
_______________________________ TestAPUTransformer.test_parse_insumo_fields_with_waste _______________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_parse_insumo_fields_with_waste>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
________________________________ TestAPUTransformer.test_special_cases_classification ________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_special_cases_classification>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
_____________________________________ TestAPUTransformer.test_validate_mo_format _____________________________________

self = <tests.test_apu_processor.TestAPUTransformer testMethod=test_validate_mo_format>

    def setUp(self):
        with suppress_logs():
            self.config = TestFixtures.get_default_config()
            self.apu_context = {
                "codigo_apu": "TEST-001",
                "descripcion_apu": "Test APU",
                "unidad_apu": "UND",
                "categoria": "TEST"
            }
>           self.transformer = APUTransformer(self.apu_context, self.config)
E           TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'

tests/test_apu_processor.py:237: TypeError
_______________________________________ TestAPUProcessor.test_batch_processing _______________________________________

self = <tests.test_apu_processor.TestAPUProcessor testMethod=test_batch_processing>

    def test_batch_processing(self):
        """Prueba procesamiento por lotes."""
        # Crear muchos registros
        many_records = self.sample_records * 50  # 250 registros
        config_with_batch = self.config.copy()
        config_with_batch['batch_size'] = 50
    
        with suppress_logs():
            processor = APUProcessor(many_records, config_with_batch)
            df = processor.process_all()
    
            self.assertIsInstance(df, pd.DataFrame)
            # Verificar que procesó múltiples lotes
>           self.assertGreaterEqual(len(df), 50)
E           AssertionError: 0 not greater than or equal to 50

tests/test_apu_processor.py:467: AssertionError
_____________________________________ TestAPUProcessor.test_clean_record_fields ______________________________________

self = <tests.test_apu_processor.TestAPUProcessor testMethod=test_clean_record_fields>

    def test_clean_record_fields(self):
        """Prueba limpieza de campos de registro."""
        processor = APUProcessor([], self.config)
    
        # Registro válido
        valid_record = {
            "apu_code": "  01.01.001  ",
            "apu_desc": "  Test Description  ",
            "apu_unit": "m2",
            "category": "TEST"
        }
        result = processor._clean_record_fields(valid_record)
        self.assertIsNotNone(result)
        self.assertEqual(result["apu_code"], "01.01.001")
        self.assertEqual(result["apu_desc"], "Test Description")
        self.assertEqual(result["apu_unit"], "M2")
    
        # Registro sin código APU
        invalid_record = {"apu_desc": "Test", "apu_unit": "UND"}
>       result = processor._clean_record_fields(invalid_record)

tests/test_apu_processor.py:488: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app/apu_processor.py:580: in _clean_record_fields
    apu_code = clean_apu_code(record.get("apu_code", ""))
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

code = '', validate_format = True

    @lru_cache(maxsize=512)
    def clean_apu_code(code: str, validate_format: bool = True) -> str:
        """
        Limpia y valida un código de APU de forma robusta con cache.
    
        Args:
            code: Código de APU a limpiar
            validate_format: Si True, valida el formato básico
    
        Returns:
            Código de APU limpio y validado
    
        Raises:
            ValueError: Si el código es inválido y validate_format=True
            TypeError: Si code no puede convertirse a string
        """
        if not isinstance(code, str):
            try:
                code = str(code)
            except Exception as e:
                raise TypeError(f"No se puede convertir código APU a string: {e}")
    
        original_code = code
        code = code.strip().upper()
    
        # Remover caracteres no permitidos (mantener letras, números, puntos, guiones)
        code = code.replace(',', '.')
        code = APU_INVALID_CHARS_PATTERN.sub('', code)
    
        # Remover puntos y guiones al final
        code = code.rstrip('.-')
    
        # Validaciones opcionales de formato
        if validate_format:
            if not code:
>               raise ValueError(f"Código APU no puede estar vacío: '{original_code}'")
E               ValueError: Código APU no puede estar vacío: ''

app/utils.py:317: ValueError
------------------------------------------------- Captured log call --------------------------------------------------
WARNING  app.apu_processor:apu_processor.py:486 Lista de registros vacía
____________________________________ TestAPUProcessor.test_infer_unit_intelligent ____________________________________

self = <tests.test_apu_processor.TestAPUProcessor testMethod=test_infer_unit_intelligent>

    def test_infer_unit_intelligent(self):
        """Prueba inferencia inteligente de unidades."""
        processor = APUProcessor([], self.config)
    
        test_cases = [
            # (descripción, categoría, tipo_insumo, unidad_esperada)
            ("Excavación manual en terreno", "OBRA", "MANO_DE_OBRA", "JOR"),
            ("Retroexcavadora CAT 320", "EQUIPO", "EQUIPO", "DIA"),
            ("Transporte de material pétreo", "TRANSPORTE", "TRANSPORTE", "VIAJE"),
            ("Concreto de 3000 PSI M3", "MATERIALES", "SUMINISTRO", "M3"),
            ("Pintura epóxica en muros", "MATERIALES", "SUMINISTRO", "M2"),
            ("Tubería PVC 4 pulgadas", "MATERIALES", "SUMINISTRO", "ML"),
        ]
    
        for desc, cat, tipo, expected in test_cases:
            with self.subTest(desc=desc):
                result = processor._infer_unit_intelligent(desc, cat, tipo)
>               self.assertEqual(result, expected)
E               AssertionError: 'UND' != 'M2'
E               - UND
E               + M2

tests/test_apu_processor.py:528: AssertionError
------------------------------------------------- Captured log call --------------------------------------------------
WARNING  app.apu_processor:apu_processor.py:486 Lista de registros vacía
_____________________________________ TestAPUProcessor.test_normalize_unit_cache _____________________________________

self = <tests.test_apu_processor.TestAPUProcessor testMethod=test_normalize_unit_cache>

    def test_normalize_unit_cache(self):
        """Prueba normalización de unidades con cache."""
        processor = APUProcessor([], self.config)
    
        test_units = [
            ("dias", "DIA"),
            ("DÍAS", "DIA"),
            ("m2", "M2"),
            ("metros cuadrados", "M2"),
            ("UN", "UND"),
            ("", "UND"),
            (None, "UND"),
            ("UNKNOWN_UNIT", "UNKNOWN_UNIT"),
        ]
    
        for input_unit, expected in test_units:
            with self.subTest(input=input_unit):
                result = processor._normalize_unit(input_unit or "")
>               self.assertEqual(result, expected)
E               AssertionError: 'DAS' != 'DIA'
E               - DAS
E               ?   -
E               + DIA
E               ?  +

tests/test_apu_processor.py:509: AssertionError
------------------------------------------------- Captured log call --------------------------------------------------
WARNING  app.apu_processor:apu_processor.py:486 Lista de registros vacía
______________________________________ TestAPUProcessor.test_process_all_basic _______________________________________

self = <tests.test_apu_processor.TestAPUProcessor testMethod=test_process_all_basic>

    def test_process_all_basic(self):
        """Prueba procesamiento básico completo."""
        with suppress_logs():
            processor = APUProcessor(self.sample_records, self.config)
            df = processor.process_all()
    
            self.assertIsInstance(df, pd.DataFrame)
>           self.assertGreater(len(df), 0)
E           AssertionError: 0 not greater than 0

tests/test_apu_processor.py:427: AssertionError
________________________________________ TestIntegration.test_error_recovery _________________________________________

self = <tests.test_apu_processor.TestIntegration testMethod=test_error_recovery>

    def test_error_recovery(self):
        """Prueba recuperación de errores durante procesamiento."""
        # Mix de registros buenos y malos
        mixed_records = (
            TestFixtures.get_sample_records() +
            TestFixtures.get_edge_case_records()
        )
    
        config = TestFixtures.get_default_config()
    
        with suppress_logs():
            processor = APUProcessor(mixed_records, config)
            df = processor.process_all()
    
            # Debe procesar sin crashes
            self.assertIsInstance(df, pd.DataFrame)
    
            # Debe haber procesado al menos los registros válidos
>           self.assertGreater(len(df), 0)
E           AssertionError: 0 not greater than 0

tests/test_apu_processor.py:816: AssertionError
_________________________________________ TestIntegration.test_full_pipeline _________________________________________

self = <tests.test_apu_processor.TestIntegration testMethod=test_full_pipeline>

    def test_full_pipeline(self):
        """Prueba pipeline completo desde registros crudos hasta costos unitarios."""
        with suppress_logs():
            # Datos de entrada
            raw_records = TestFixtures.get_sample_records()
            config = TestFixtures.get_default_config()
    
            # Procesar
            processor = APUProcessor(raw_records, config)
            df_processed = processor.process_all()
    
            # Validar procesamiento
>           self.assertGreater(len(df_processed), 0)
E           AssertionError: 0 not greater than 0

tests/test_apu_processor.py:766: AssertionError
___________________________________ TestIntegration.test_large_dataset_performance ___________________________________

self = <tests.test_apu_processor.TestIntegration testMethod=test_large_dataset_performance>

    def test_large_dataset_performance(self):
        """Prueba performance con dataset grande."""
        # Generar dataset grande
        base_records = TestFixtures.get_sample_records()
        large_dataset = base_records * 200  # 1000 registros
    
        config = TestFixtures.get_default_config()
        config['batch_size'] = 100
    
        with suppress_logs():
            start_time = time.time()
            processor = APUProcessor(large_dataset, config)
            df = processor.process_all()
            elapsed = time.time() - start_time
    
            # Debe procesar en tiempo razonable (< 10 segundos para 1000 registros)
            self.assertLess(elapsed, 10, f"Procesamiento muy lento: {elapsed:.2f}s")
    
            # Debe procesar al menos 50% de los registros
>           self.assertGreater(len(df), len(large_dataset) * 0.5)
E           AssertionError: 0 not greater than 500.0

tests/test_apu_processor.py:796: AssertionError
================================================== warnings summary ==================================================
tests/test_apu_processor.py::TestAPUProcessor::test_batch_processing
tests/test_apu_processor.py::TestAPUProcessor::test_build_optimized_dataframe
tests/test_apu_processor.py::TestAPUProcessor::test_process_all_basic
tests/test_apu_processor.py::TestIntegration::test_error_recovery
tests/test_apu_processor.py::TestIntegration::test_full_pipeline
tests/test_apu_processor.py::TestIntegration::test_large_dataset_performance
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:294: UserWarning: Inconsistencia: tipo_insumo='OTRO' pero categoria='MATERIALES'. Se recomienda alinear ambos campos.
    super()._validate_consistency()

tests/test_apu_processor.py::TestAPUProcessor::test_batch_processing
tests/test_apu_processor.py::TestAPUProcessor::test_build_optimized_dataframe
tests/test_apu_processor.py::TestAPUProcessor::test_process_all_basic
tests/test_apu_processor.py::TestIntegration::test_error_recovery
tests/test_apu_processor.py::TestIntegration::test_full_pipeline
tests/test_apu_processor.py::TestIntegration::test_large_dataset_performance
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:294: UserWarning: Inconsistencia: tipo_insumo='OTRO' pero categoria='MANO DE OBRA'. Se recomienda alinear ambos campos.
    super()._validate_consistency()

tests/test_apu_processor.py::TestAPUProcessor::test_batch_processing
tests/test_apu_processor.py::TestAPUProcessor::test_build_optimized_dataframe
tests/test_apu_processor.py::TestAPUProcessor::test_process_all_basic
tests/test_apu_processor.py::TestIntegration::test_error_recovery
tests/test_apu_processor.py::TestIntegration::test_full_pipeline
tests/test_apu_processor.py::TestIntegration::test_large_dataset_performance
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:294: UserWarning: Inconsistencia: tipo_insumo='OTRO' pero categoria='EQUIPO'. Se recomienda alinear ambos campos.
    super()._validate_consistency()

tests/test_apu_processor.py::TestAPUProcessor::test_batch_processing
tests/test_apu_processor.py::TestAPUProcessor::test_process_all_basic
tests/test_apu_processor.py::TestIntegration::test_error_recovery
tests/test_apu_processor.py::TestIntegration::test_full_pipeline
tests/test_apu_processor.py::TestIntegration::test_large_dataset_performance
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:294: UserWarning: Inconsistencia: tipo_insumo='OTRO' pero categoria='TRANSPORTE'. Se recomienda alinear ambos campos.
    super()._validate_consistency()

tests/test_apu_processor.py::TestAPUProcessor::test_fix_squad_units
tests/test_apu_processor.py::TestAPUProcessor::test_handle_duplicates
tests/test_apu_processor.py::TestAPUProcessor::test_validate_by_type
tests/test_apu_processor.py::TestAPUProcessor::test_validate_final_insumo
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:162: UserWarning: Inconsistencia: tipo_insumo='MANO_DE_OBRA' pero categoria='MO'. Se recomienda alinear ambos campos.
    super()._validate_consistency()

tests/test_apu_processor.py::TestAPUProcessor::test_fix_squad_units
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:91: UserWarning: Mano de Obra: unidades 'UNIDAD' o 'JOR' no son típicas. Unidades esperadas: {'MES', 'SEMANA', 'DIA', 'HORA'}
    self._validate_consistency()

tests/test_apu_processor.py::TestAPUProcessor::test_fix_squad_units
tests/test_apu_processor.py::TestAPUProcessor::test_handle_duplicates
tests/test_apu_processor.py::TestAPUProcessor::test_validate_by_type
tests/test_apu_processor.py::TestAPUProcessor::test_validate_final_insumo
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:91: UserWarning: Mano de Obra: unidades 'JOR' o 'JOR' no son típicas. Unidades esperadas: {'MES', 'SEMANA', 'DIA', 'HORA'}
    self._validate_consistency()

tests/test_apu_processor.py::TestAPUProcessor::test_process_edge_cases
tests/test_apu_processor.py::TestIntegration::test_error_recovery
tests/test_apu_processor.py::TestRegression::test_scientific_notation
tests/test_apu_processor.py::TestRegression::test_very_long_descriptions
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:294: UserWarning: Inconsistencia: tipo_insumo='OTRO' pero categoria='TEST'. Se recomienda alinear ambos campos.
    super()._validate_consistency()

tests/test_apu_processor.py::TestRegression::test_unicode_handling
  /home/gerardo/Documentos/GitHub/apu_filter/app/schemas.py:294: UserWarning: Inconsistencia: tipo_insumo='OTRO' pero categoria='SEÑALIZACIÓN'. Se recomienda alinear ambos campos.
    super()._validate_consistency()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
============================================== short test summary info ===============================================
FAILED tests/test_apu_processor.py::TestKeywordCache::test_all_keyword_categories - TypeError: KeywordCache.__init__() missing 1 required positional argument: 'config'
FAILED tests/test_apu_processor.py::TestKeywordCache::test_lazy_initialization - TypeError: KeywordCache.__init__() missing 1 required positional argument: 'config'
FAILED tests/test_apu_processor.py::TestKeywordCache::test_no_duplicate_keywords - TypeError: KeywordCache.__init__() missing 1 required positional argument: 'config'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_build_insumo_basico_variations - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_build_mo_completa_failure_cases - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_build_mo_completa_success - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_classify_insumo_with_cache - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_clean_token_variations - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_correct_total_value - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_0 - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_1 - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_2 - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_detect_format_scenarios_3 - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_parse_insumo_fields_with_waste - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_special_cases_classification - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUTransformer::test_validate_mo_format - TypeError: APUTransformer.__init__() missing 1 required positional argument: 'keyword_cache'
FAILED tests/test_apu_processor.py::TestAPUProcessor::test_batch_processing - AssertionError: 0 not greater than or equal to 50
FAILED tests/test_apu_processor.py::TestAPUProcessor::test_clean_record_fields - ValueError: Código APU no puede estar vacío: ''
FAILED tests/test_apu_processor.py::TestAPUProcessor::test_infer_unit_intelligent - AssertionError: 'UND' != 'M2'
- UND
+ M2
FAILED tests/test_apu_processor.py::TestAPUProcessor::test_normalize_unit_cache - AssertionError: 'DAS' != 'DIA'
- DAS
?   -
+ DIA
?  +
FAILED tests/test_apu_processor.py::TestAPUProcessor::test_process_all_basic - AssertionError: 0 not greater than 0
FAILED tests/test_apu_processor.py::TestIntegration::test_error_recovery - AssertionError: 0 not greater than 0
FAILED tests/test_apu_processor.py::TestIntegration::test_full_pipeline - AssertionError: 0 not greater than 0
FAILED tests/test_apu_processor.py::TestIntegration::test_large_dataset_performance - AssertionError: 0 not greater than 500.0
==================================== 24 failed, 19 passed, 37 warnings in 11.60s =====================================