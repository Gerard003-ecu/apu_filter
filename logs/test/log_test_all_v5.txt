================================================================= test session starts =================================================================
platform darwin -- Python 3.12.3, pytest-8.4.2, pluggy-1.6.0 -- /Users/gerardomayor/Documents/estru_techos/apu_filter/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/gerardomayor/Documents/estru_techos/apu_filter
configfile: pyproject.toml
collected 30 items                                                                                                                                    

tests/test_app.py::TestAppEndpoints::test_get_estimate_with_session FAILED                                                                      [  3%]
tests/test_apu_processor.py::TestAPUProcessor::test_exclusion_of_metadata_insumos PASSED                                                        [  6%]
tests/test_apu_processor.py::TestAPUProcessor::test_mo_rendimiento_calculation PASSED                                                           [ 10%]
tests/test_apu_processor.py::TestAPUProcessor::test_numeric_conversion_and_calculations PASSED                                                  [ 13%]
tests/test_apu_processor.py::TestAPUProcessor::test_unit_inference PASSED                                                                       [ 16%]
tests/test_data_validator.py::TestDataValidator::test_validate_and_clean_data_integration PASSED                                                [ 20%]
tests/test_data_validator.py::TestDataValidator::test_validate_extreme_costs PASSED                                                             [ 23%]
tests/test_data_validator.py::TestDataValidator::test_validate_missing_descriptions PASSED                                                      [ 26%]
tests/test_data_validator.py::TestDataValidator::test_validate_zero_quantity_with_cost PASSED                                                   [ 30%]
tests/test_estimator.py::TestEstimatorWithNewData::test_calculate_estimate_flexible_search PASSED                                               [ 33%]
tests/test_estimator.py::TestEstimatorWithNewData::test_calculate_estimate_logic_two_step FAILED                                                [ 36%]
tests/test_models.py::TestProbabilityModels::test_sanitize_value PASSED                                                                         [ 40%]
tests/test_models.py::TestProbabilityModels::test_simulation_handles_empty_input PASSED                                                         [ 43%]
tests/test_models.py::TestProbabilityModels::test_simulation_handles_missing_columns PASSED                                                     [ 46%]
tests/test_models.py::TestProbabilityModels::test_simulation_handles_zero_cost_input PASSED                                                     [ 50%]
tests/test_models.py::TestProbabilityModels::test_simulation_returns_correct_structure PASSED                                                   [ 53%]
tests/test_models.py::TestProbabilityModels::test_simulation_values_are_reasonable PASSED                                                       [ 56%]
tests/test_procesador_csv.py::TestCSVProcessorWithNewData::test_abnormally_high_cost_triggers_error PASSED                                      [ 60%]
tests/test_procesador_csv.py::TestCSVProcessorWithNewData::test_cartesian_explosion_on_final_merge PASSED                                       [ 63%]
tests/test_procesador_csv.py::TestCSVProcessorWithNewData::test_process_all_files_structure_and_calculations PASSED                             [ 66%]
tests/test_report_parser_crudo.py::TestReportParserCrudo::test_basic_raw_extraction PASSED                                                      [ 70%]
tests/test_report_parser_crudo.py::TestReportParserCrudo::test_inline_description_extraction PASSED                                             [ 73%]
tests/test_report_parser_crudo.py::TestReportParserCrudo::test_multiple_apus_raw PASSED                                                         [ 76%]
tests/test_report_parser_crudo.py::TestReportParserCrudo::test_no_numeric_conversion PASSED                                                     [ 80%]
tests/test_schemas.py::test_insumo_procesado PASSED                                                                                             [ 83%]
tests/test_schemas.py::test_mano_de_obra PASSED                                                                                                 [ 86%]
tests/test_schemas.py::test_equipo PASSED                                                                                                       [ 90%]
tests/test_schemas.py::test_suministro PASSED                                                                                                   [ 93%]
tests/test_schemas.py::test_transporte PASSED                                                                                                   [ 96%]
tests/test_schemas.py::test_otro PASSED                                                                                                         [100%]

====================================================================== FAILURES =======================================================================
___________________________________________________ TestAppEndpoints.test_get_estimate_with_session ___________________________________________________

self = <tests.test_app.TestAppEndpoints testMethod=test_get_estimate_with_session>

    def test_get_estimate_with_session(self):
        """
        Prueba el flujo completo de carga de datos y solicitud de estimación.
    
        Simula una petición POST a `/upload` con los archivos de prueba y luego
        una petición POST a `/api/estimate` para verificar que el cálculo se
        realiza correctamente utilizando los datos de la sesión.
        """
        with self.client as c:
            # Simular la carga de archivos para crear una sesión de datos
            data = {
                "presupuesto": self._get_test_file("presupuesto.csv", PRESUPUESTO_DATA),
                "apus": self._get_test_file("apus.csv", APUS_DATA),
                "insumos": self._get_test_file("insumos.csv", INSUMOS_DATA),
            }
            # Asignar la configuración de prueba directamente a la aplicación
            c.application.config["APP_CONFIG"] = TEST_CONFIG
            upload_response = c.post(
                "/upload", data=data, content_type="multipart/form-data"
            )
            self.assertEqual(upload_response.status_code, 200)
    
            # Solicitar una estimación con los parámetros definidos
            estimate_params = {"material": "TEJA", "cuadrilla": "1"}
            response = c.post("/api/estimate", json=estimate_params)
            self.assertEqual(response.status_code, 200)
            json_data = json.loads(response.data)
    
            # Aserciones basadas en los nuevos datos de prueba (ver test_estimator.py)
            self.assertAlmostEqual(json_data["valor_suministro"], 50000.0, places=2)
>           self.assertAlmostEqual(json_data["valor_instalacion"], 11760.0, places=2)
E           AssertionError: 11200.0 != 11760.0 within 2 places (560.0 difference)

tests/test_app.py:107: AssertionError
------------------------------------------------------------------ Captured log call ------------------------------------------------------------------
WARNING  app.apu_processor:apu_processor.py:736 Rechazado: Jornal de MO fuera de rango ($11,200.00) para 'HERRAMIENTA MENOR (% MANO DE OBRA)...'
WARNING  app.apu_processor:apu_processor.py:931 ⚠️ NO SE ENCONTRÓ EQUIPO para instalación
___________________________________________ TestEstimatorWithNewData.test_calculate_estimate_logic_two_step ___________________________________________

self = <tests.test_estimator.TestEstimatorWithNewData testMethod=test_calculate_estimate_logic_two_step>

    def test_calculate_estimate_logic_two_step(self):
        """
        Prueba el escenario ideal donde existen APUs claros y separados para
        suministro e instalación de un material.
    
        Verifica que `calculate_estimate` identifique correctamente cada APU,
        extraiga los valores correctos y calcule el costo total de construcción
        y el rendimiento esperado.
        """
        params = {"material": "TEJA", "cuadrilla": "1"}
        result = calculate_estimate(params, self.data_store, TEST_CONFIG)
    
        self.assertNotIn("error", result)
        # Verificar que se encontraron las descripciones correctas
        self.assertIn(
            "Suministro: SUMINISTRO TEJA TRAPEZOIDAL ROJA CAL.28",
            result["apu_encontrado"],
        )
        self.assertIn("Tarea: INSTALACION TEJA TRAPEZOIDAL", result["apu_encontrado"])
        self.assertIn(
            "Cuadrilla: CUADRILLA TIPO 1 (1 OF + 2 AYU)", result["apu_encontrado"]
        )
    
        # Verificar los valores calculados con los nuevos datos
        self.assertAlmostEqual(result["valor_suministro"], 50000.0, places=2)
>       self.assertAlmostEqual(result["valor_instalacion"], 11760.0, places=2)
E       AssertionError: np.float64(11200.0) != 11760.0 within 2 places (np.float64(560.0) difference)

tests/test_estimator.py:94: AssertionError
=============================================================== short test summary info ===============================================================
FAILED tests/test_app.py::TestAppEndpoints::test_get_estimate_with_session - AssertionError: 11200.0 != 11760.0 within 2 places (560.0 difference)
FAILED tests/test_estimator.py::TestEstimatorWithNewData::test_calculate_estimate_logic_two_step - AssertionError: np.float64(11200.0) != 11760.0 within 2 places (np.float64(560.0) difference)
============================================================ 2 failed, 28 passed in 10.23s ============================================================